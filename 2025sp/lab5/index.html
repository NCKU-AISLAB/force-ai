
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab4/">
      
      
        <link rel="next" href="../../developers/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Lab 5 - AI Compiler - FORCE AI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-5-ai-compiler" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="FORCE AI" class="md-header__button md-logo" aria-label="FORCE AI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FORCE AI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 5 - AI Compiler
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh/2025sp/lab5/" hreflang="zh" class="md-select__link">
              繁體中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/NCKU-AISLAB/force-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aislab/force-ai
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  
  Tutorial

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../developers/" class="md-tabs__link">
        
  
  
    
  
  Developer Guides

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FORCE AI" class="md-nav__button md-logo" aria-label="FORCE AI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    FORCE AI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NCKU-AISLAB/force-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aislab/force-ai
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 1 - AI Model Design and Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 2 - Performance Modeling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 3 - Hardware Architecture Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 4 - Runtime and Performance Profiling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Lab 5 - AI Compiler
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Lab 5 - AI Compiler
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-50-enviroment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.0 - Enviroment Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-51-introduction-to-ai-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.1 - Introduction to AI Compiler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.1 - Introduction to AI Compiler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tvm" class="md-nav__link">
    <span class="md-ellipsis">
      TVM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-codegen-byoc" class="md-nav__link">
    <span class="md-ellipsis">
      Bring Your Own Codegen (BYOC)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-52-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.2 - Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.2 - Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operator-fusion" class="md-nav__link">
    <span class="md-ellipsis">
      Operator Fusion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-53-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.3 - Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.3 - Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview-of-c-codegen-in-python-version" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of C codegen in Python version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tvm-relay-external-codegen-c-backend-walkthrough-codegenpy" class="md-nav__link">
    <span class="md-ellipsis">
      TVM Relay External Codegen: C Backend Walkthrough - codegen.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset-preprocessing-for-c-deployment-datagenpy" class="md-nav__link">
    <span class="md-ellipsis">
      Dataset Preprocessing for C Deployment - datagen.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tvm-function-call-generation-for-quantized-inference-notepy" class="md-nav__link">
    <span class="md-ellipsis">
      TVM Function Call Generation for Quantized Inference - note.py
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-54-performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.4 - Performance Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.4 - Performance Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#massif-heap-memory-profiler" class="md-nav__link">
    <span class="md-ellipsis">
      massif: Heap Memory Profiler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ms_print-text-based-memory-usage-graph" class="md-nav__link">
    <span class="md-ellipsis">
      ms_print: Text-Based Memory Usage Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#massif-visualizer-gui-for-massif-output" class="md-nav__link">
    <span class="md-ellipsis">
      massif-visualizer: GUI for Massif Output
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice" class="md-nav__link">
    <span class="md-ellipsis">
      Practice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Directory Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-codegen-with-tvm-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      1. Codegen with TVM compiler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-simulation-and-performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      2. Simulation and Performance Analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up_1" class="md-nav__link">
    <span class="md-ellipsis">
      Clean Up
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developer Guides
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-50-enviroment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.0 - Enviroment Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-51-introduction-to-ai-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.1 - Introduction to AI Compiler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.1 - Introduction to AI Compiler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tvm" class="md-nav__link">
    <span class="md-ellipsis">
      TVM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-codegen-byoc" class="md-nav__link">
    <span class="md-ellipsis">
      Bring Your Own Codegen (BYOC)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-52-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.2 - Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.2 - Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operator-fusion" class="md-nav__link">
    <span class="md-ellipsis">
      Operator Fusion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-53-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.3 - Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.3 - Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview-of-c-codegen-in-python-version" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of C codegen in Python version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tvm-relay-external-codegen-c-backend-walkthrough-codegenpy" class="md-nav__link">
    <span class="md-ellipsis">
      TVM Relay External Codegen: C Backend Walkthrough - codegen.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dataset-preprocessing-for-c-deployment-datagenpy" class="md-nav__link">
    <span class="md-ellipsis">
      Dataset Preprocessing for C Deployment - datagen.py
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tvm-function-call-generation-for-quantized-inference-notepy" class="md-nav__link">
    <span class="md-ellipsis">
      TVM Function Call Generation for Quantized Inference - note.py
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-54-performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 5.4 - Performance Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 5.4 - Performance Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#massif-heap-memory-profiler" class="md-nav__link">
    <span class="md-ellipsis">
      massif: Heap Memory Profiler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ms_print-text-based-memory-usage-graph" class="md-nav__link">
    <span class="md-ellipsis">
      ms_print: Text-Based Memory Usage Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#massif-visualizer-gui-for-massif-output" class="md-nav__link">
    <span class="md-ellipsis">
      massif-visualizer: GUI for Massif Output
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice" class="md-nav__link">
    <span class="md-ellipsis">
      Practice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Directory Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-codegen-with-tvm-compiler" class="md-nav__link">
    <span class="md-ellipsis">
      1. Codegen with TVM compiler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-simulation-and-performance-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      2. Simulation and Performance Analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up_1" class="md-nav__link">
    <span class="md-ellipsis">
      Clean Up
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lab-5-ai-compiler">Lab 5 - AI Compiler</h1>
<h2 id="overview">Overview</h2>
<p>In this lab, we will implement an AI compiler flow that bridges high-level machine learning models with low-level C code deployment, targeting CPU execution. By integrating TVM, a machine learning compiler framework, with a code generator and pattern fusion engine, we create an end-to-end system capable of compiling models like PyTorch into optimized C code. The compiler serves as a crucial translation and optimization layer, converting models from intermediate representations (Relay) into fused, low-level operator sequences suitable for embedded or resource-constrained environments.</p>
<p>The code generation runtime, which controls this compilation pipeline, leverages modular passes such as operator fusion, pattern recognition, and C function call generation to produce executable code that mimics real hardware accelerator deployment. This abstraction allows us to study inference performance and correctness in a software-only context, simulating hardware-constrained environments.</p>
<p>Moreover, the lab guides us through implementing key components such as Relay operator fusion, model traversal, and shape-aware codegen logic. Through these implementations, we investigate how compiler-level optimizations—like operator fusion and quantization-aware generation—impact inference performance and portability. Ultimately, this lab equips us with practical insights into how AI compilers serve as a critical infrastructure in deploying deep learning models across heterogeneous platforms.</p>
<h2 id="lab-50-enviroment-setup">Lab 5.0 - Enviroment Setup</h2>
<p>In the upcoming assignment, TVM will be required. Please follow the instructions below to set up the environment.</p>
<p>Set up the basic environment and download the required configurations.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>tvm-lab
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>conda<span class="w"> </span>activate<span class="w"> </span>tvm-lab
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.11
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">llvmdev</span><span class="o">=</span><span class="m">18</span><span class="w"> </span>-c<span class="w"> </span>conda-forge
</span></code></pre></div>
<blockquote>
<p>[!Warning]
If you encounter an issue where Conda is not found, it means Conda has not been installed. The installation guide for Miniconda can be found in Lab 0.</p>
</blockquote>
<p>We need the <strong>CPU version</strong> of <code>torchvision</code>, and the TVM version is already installed on the server. Please use the following command to install it to your local conda environment.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip3<span class="w"> </span>install<span class="w"> </span>torch<span class="w"> </span>torchvision<span class="w"> </span>--index-url<span class="w"> </span>https://download.pytorch.org/whl/cpu
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>pip3<span class="w"> </span>install<span class="w"> </span>onnx
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>pip3<span class="w"> </span>install<span class="w"> </span>graphviz
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>pip3<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>/opt/tvm/python
</span></code></pre></div>
<p>After completing the above steps, extract the files from Moodle and place them on the server.</p>
<h2 id="lab-51-introduction-to-ai-compiler">Lab 5.1 - Introduction to AI Compiler</h2>
<p>AI compilers enable the deployment of models from high-level frameworks like TensorFlow and PyTorch onto various hardware platforms such as CPUs, GPUs, and AI accelerators by transforming high-level code into low-level executable code.</p>
<h3 id="tvm">TVM</h3>
<p>One such compiler is <a href="https://tvm.apache.org/">TVM</a>, an open-source machine learning compiler framework designed to optimize and deploy deep learning models efficiently across diverse hardware targets. TVM automates the process of translating models into optimized code tailored to specific hardware architectures.</p>
<p><img alt="image" src="../../assets/images/S1JipjLyll.png" /></p>
<h3 id="bring-your-own-codegen-byoc">Bring Your Own Codegen (BYOC)</h3>
<p>The compilation process begins by converting models from TensorFlow or PyTorch into an Intermediate Representation (IR). In the high-level IR, computations are structured as a computation graph, where each node represents an operation (e.g., matrix multiplication, convolution). This graph is then progressively optimized through multiple stages. Finally, TVM’s code generation (codegen) module translates the optimized IR into low-level C code or other backend-specific code for execution on the target hardware.</p>
<p>For more information about BYOC, see <a href="https://tvm.apache.org/2020/07/15/how-to-bring-your-own-codegen-to-tvm">How to Bring Your Own Codegen to TVM</a></p>
<!--digraph compiler_flow {
    rankdir=LR;
    node [shape=box style=filled fontname="Arial"];

    pytorchinput [label="pytorch model", fillcolor="#ffe6cc"];
    tensorflowinput [label="tensorflow model", fillcolor="#ffe6cc"];
    onnxinput [label="onnx model", fillcolor="#ffe6cc"];

    relay [label="relay", fillcolor="#fff2cc"];
    optimization [label="graph\noptimization", fillcolor="#fff2cc"];
    codegen [label="code\ngenerate", fillcolor="#fff2cc"];
    ccode [label="C Code", fillcolor="#f8d9d9"];


    tensorflowinput -> relay;
    onnxinput -> relay;
    pytorchinput -> relay -> optimization -> codegen -> ccode;

    // Virtual label node for intermediate representations
    model_label [label="intermediate representations", fillcolor="#ffffff",shape=none, fontsize=10];
    { rank=same; model_label; pytorchinput; tensorflowinput; onnxinput;}

    // Virtual label node for intermediate representations
    ir_label [label="intermediate representations", fillcolor="#ffffff",shape=none, fontsize=10];
    { rank=same; ir_label; relay;}

    // Virtual label node for computing graph
    cg_label [label="computing graph",fillcolor="#ffffff", shape=none, fontsize=10];
    { rank=same; cg_label; optimization }
}-->

<p><img src="../../assets/svgs/lab5_graphviz_0.svg" alt="graphviz_0"></p>
<div class="admonition question">
<p class="admonition-title">Question: What will Relay look like?</p>
<p>After being converted by TVM, the high-level Relay representation will look like this.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>def @main(%input: Tensor[(1, 3, 32, 32), float32] /* ty=Tensor[(1, 3, 32, 32), float32] span=/quant/QuantizeLinear.input:0:0 */) -&gt; Tensor[(1, 10), float32] {
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>  %0 = qnn.quantize(%input, 0.015625f /* ty=float32 span=/quant/Constant_1:0:0 */, 128 /* ty=int32 span=/quant/QuantizeLinear:0:0 */, out_dtype=&quot;uint8&quot;, axis=1) &gt;/* ty=Tensor[(1, 3, 32, 32), uint8] span=/quant/QuantizeLinear:0:0 */;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>  %1 = cast(%0, dtype=&quot;uint8&quot;) /* ty=Tensor[(1, 3, 32, 32), uint8] span=/module/conv1/0/Cast:0:0 */;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  %2 = qnn.dequantize(%1, 0.015625f /* ty=float32 span=/module/conv1/0/Constant:0:0 */, 128 /* ty=int32 span=/module/conv1/0/DequantizeLinear:0:0 */, out_dtype=&quot;float32&quot;, axis=1) /* ty=Tensor[(1, 3, 32, 32), float32] span=/module/conv1/0/DequantizeLinear:0:0 */;
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>  %3 = qnn.dequantize(meta[relay.Constant][0] /* ty=Tensor[(64, 3, 3, 3), int8] span=/module/conv1/0/Constant_2:0:0 */, meta[relay.Constant][1] /* ty=Tensor[(1), float32] span=/module/conv1/0/Constant_3:0:0 */, meta[relay.Constant][2] /* ty=Tensor[(1), int32] span=/module/conv1/0/DequantizeLinear_1:0:0 */, out_dtype=&quot;float32&quot;, axis=1) /* ty=Tensor[(64, 3, 3, 3), float32] span=/module/conv1/0/DequantizeLinear_1:0:0 */;
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>  ...
</span></code></pre></div>
<p>It will precisely record each execution step along with detailed information, such as input shape, data type, and more. Once the Relay representation is obtained, optimizations can begin.</p>
</div>
<p>In this lab, our objective is to take the input Relay, apply fusion techniques to combine specific operators, and generate a fused Relay. Subsequently, we will perform code generation on the fused Relay to produce the output files marked in green, located along the designated path on the right.</p>
<p>In typical scenarios, TVM's C code generator is implemented as a C++ class that must be registered within TVM's function registry. After registration, TVM needs to be rebuilt in order to trigger the customized code generator through the Python API using <code>relay.build()</code>. However, TVM also offers an alternative design that allows implementing the code generator directly in Python. In this case, the function can be registered using a decorator. It is important to note that such functions must take a Relay model as input and return a string containing the generated code in either C++ or C.</p>
<p>According to the <strong>BYOC (Bring Your Own Codegen)</strong> framework, in order to produce an executable as part of the standard TVM compilation flow, the custom code generator must conform to the DLPack specification, and data transmission must utilize DLTensor. However, since our approach focuses on an end-to-end code generation flow, we bypass TVM’s generated output files. Instead, we directly invoke our code generator to produce both the model’s C source code and the corresponding binary weight data.</p>
<!--digraph tvm_codegen_flow {
    rankdir=TB;
    splines=false;
    node [shape=box style=filled fontname="Arial"];

    // === High-level IR block ===
    subgraph cluster_ir {
        label = "Intermediate Representation (IR)";
        fontsize=10;
        style=dashed;
        color=lightgray;
        relay [label="relay", fillcolor="#c6dbef"];
        fused_relay [label="fused relay", fillcolor="#c6dbef"];
    }

    // === Codegen block ===
    subgraph cluster_codegen {
        label = "Code Generation";
        fontsize=10;
        style=dashed;
        color=lightgray;
        codegen [label="C codegen", fillcolor="#c6dbef"];
        model_c [label="model.c", fillcolor="#ccebc5"];
        weight_c [label="weight.c", fillcolor="#ccebc5"];
    }

    // === Runtime block ===
    runtime [label="runtime (.c/.json)", fillcolor="#fbb4ae"];

    // === Edges ===
    relay -> fused_relay [label="   merge composite"];
    fused_relay -> codegen;
    fused_relay -> runtime;
    codegen -> model_c;
    codegen -> weight_c;
    codegen -> runtime;
}-->

<p><img src="../../assets/svgs/lab5_graphviz_1.svg" alt="graphviz_1"></p>
<h2 id="lab-52-optimization">Lab 5.2 - Optimization</h2>
<h3 id="operator-fusion">Operator Fusion</h3>
<p>In Lab 4, we implemented the runtime API for the CPU and the driver for the DLA. It's important to note that the operations of these APIs are not purely single operations. Instead, they function more like fused operators within a single function, such as <code>conv2d_relu</code>, <code>conv2d_relu_maxpool</code>, and so on. To handle this, we use TVM to automatically detect patterns from the Relay model graph and fuse these patterns into a single representative node, called a <strong>Composite</strong>. Next, we annotate these nodes for the specific target (or compiler). Finally, we merge these compiler regions to obtain the Fused Relay model, which is then used by our customized code generator.</p>
<p>Fusing multiple operators helps reduce memory accesses, thereby minimizing data movement and improving performance.</p>
<p>Based on the <code>merge_composite_pass</code> function in <code>fuse.py</code>, we need to create a pattern_table to identify subgraphs that match specific patterns. Therefore, our goal here is to properly construct the pattern_table.</p>
<p><div class="language-python highlight"><span class="filename">aoc2025-lab5/StudentID_lab5/Python/utils/fuse.py</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@register_pattern_table</span><span class="p">(</span><span class="n">COMPILER_NAME</span><span class="p">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span><span class="w">  </span><span class="nf">pattern_table</span><span class="p">():</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">acc_pattern_tables</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.qconv2d_relu_maxpool&quot;</span><span class="p">,</span> <span class="n">fuse_conv2d_bias_add_relu_max_pool2d</span><span class="p">()),</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.qconv2d_relu&quot;</span><span class="p">,</span> <span class="n">fuse_conv2d_bias_add_relu</span><span class="p">()),</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.qlinear_relu&quot;</span><span class="p">,</span> <span class="n">fuse_dense_add_relu</span><span class="p">()),</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.qlinear&quot;</span><span class="p">,</span> <span class="n">fuse_dense_add</span><span class="p">()),</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.flatten&quot;</span><span class="p">,</span> <span class="n">fuse_flatten</span><span class="p">()),</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.quantize&quot;</span><span class="p">,</span> <span class="n">quantize</span><span class="p">()),</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">.dequantize&quot;</span><span class="p">,</span> <span class="n">dequantize</span><span class="p">()),</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="p">]</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="k">return</span> <span class="n">acc_pattern_tables</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="c1"># Define the fusion function</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_composite_pass</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="k">with</span> <span class="n">tvm</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">PassContext</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="n">model_progress</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;MergeComposite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">MergeComposite</span><span class="p">(</span><span class="n">pattern_table</span><span class="p">())(</span><span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">])</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;AnnotateTarget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">AnnotateTarget</span><span class="p">([</span><span class="n">COMPILER_NAME</span><span class="p">])(</span><span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;MergeComposite&#39;</span><span class="p">])</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>        <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;MergeCompilerRegions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">MergeCompilerRegions</span><span class="p">()(</span><span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;AnnotateTarget&#39;</span><span class="p">])</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;PartitionGraph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">PartitionGraph</span><span class="p">()(</span><span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;MergeCompilerRegions&#39;</span><span class="p">])</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">model_progress</span><span class="p">,</span> <span class="n">model_progress</span><span class="p">[</span><span class="s1">&#39;PartitionGraph&#39;</span><span class="p">])</span>
</span></code></pre></div>
To complete the pattern_table, we need to implement several fusion functions defined within it.</p>
<p>Here, let's use <code>fuse_conv2d_bias_add_relu</code> as an example to explain.</p>
<div class="language-python highlight"><span class="filename">aoc2025-lab5/StudentID_lab5/Python/utils/fuse.py</span><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">fuse_conv2d_bias_add_relu</span><span class="p">():</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="c1"># Define the pattern for the operations to be fused</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="n">i</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">()</span>  <span class="c1"># Input</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="n">w</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">()</span>  <span class="c1"># Weight</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">()</span>  <span class="c1"># Bias</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">dequantized_i</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;qnn.dequantize&quot;</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">(),</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">())</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">dequantized_w</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;qnn.dequantize&quot;</span><span class="p">)(</span><span class="n">w</span><span class="p">,</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">(),</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">())</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">dequantized_b</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;qnn.dequantize&quot;</span><span class="p">)(</span><span class="n">b</span><span class="p">,</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">(),</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">())</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">conv2d_op</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;nn.conv2d&quot;</span><span class="p">)(</span><span class="n">dequantized_i</span><span class="p">,</span><span class="n">dequantized_w</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">bias_add_op</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;nn.bias_add&quot;</span><span class="p">)(</span><span class="n">conv2d_op</span><span class="p">,</span> <span class="n">dequantized_b</span><span class="p">)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">relu_op</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;nn.relu&quot;</span><span class="p">)(</span><span class="n">bias_add_op</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">quantize_op</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;qnn.quantize&quot;</span><span class="p">)(</span><span class="n">relu_op</span><span class="p">,</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">(),</span><span class="n">dfp</span><span class="o">.</span><span class="n">wildcard</span><span class="p">())</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">cast_op</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">is_op</span><span class="p">(</span><span class="s2">&quot;cast&quot;</span><span class="p">)(</span><span class="n">quantize_op</span><span class="p">)</span>  <span class="c1"># Assuming requantize is a cast operation</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="k">return</span> <span class="n">cast_op</span>
</span></code></pre></div>
<p>Using <code>fuse_conv2d_bias_add_relu()</code> as an example, note that wildcards in TVM represent patterns that can match any Relay expression.</p>
<p>First, we use wildcards to represent the input, weight, and bias tensors.</p>
<p>Next, we sequence the operations in the following order: <code>conv2d</code>, followed by <code>bias_add</code>, and then <code>relu</code>.</p>
<p>After applying these operations, we quantize the result back to the original data type. Finally, we cast the data to meet the hardware requirements before returning the final output.</p>
<ul>
<li>The following diagram illustrates the structure of the pattern:</li>
</ul>
<!--digraph pattern {
    node [shape=box, style=filled, color=lightyellow];

    i [label="wildcard\n(i)"];
    w [label="wildcard\n(w)"];
    b [label="wildcard\n(b)"];
    wi1 [label="wildcard", style=filled, color=lightgoldenrod1];
    wi2 [label="wildcard", style=filled, color=lightgoldenrod1];
    ww1 [label="wildcard", style=filled, color=lightgoldenrod1];
    ww2 [label="wildcard", style=filled, color=lightgoldenrod1];
    wb1 [label="wildcard", style=filled, color=lightgoldenrod1];
    wb2 [label="wildcard", style=filled, color=lightgoldenrod1];

    node [shape=box, style=filled, color=lightblue];
    dq_i [label="dequantize"];
    dq_w [label="dequantize"];
    dq_b [label="dequantize"];
    conv [label="conv2d"];
    bias_add [label="bias_add"];
    relu [label="relu"];
    quant [label="quantize"];
    cast [label="cast"];
    cast_op [label="cast_op", style=filled, color=white];

    // Connections
    i -> dq_i;
    wi1 -> dq_i;
    wi2 -> dq_i;

    w -> dq_w;
    ww1 -> dq_w;
    ww2 -> dq_w;

    b -> dq_b;
    wb1 -> dq_b;
    wb2 -> dq_b;

    dq_i -> conv [label="   dequantized_i"];
    dq_w -> conv [label=" dequantized_w  "];
    conv -> bias_add [label="  conv2d_op "];
    dq_b -> bias_add [label="  dequantized_b"];
    bias_add -> relu [label="  bias_add_op"];
    relu -> quant [label="  relu_op"];
    quant -> cast [label="  quantize_op"];
    cast -> cast_op;
}-->

<p><img src="../../assets/svgs/lab5_graphviz_2.svg" alt="graphviz_2"></p>
<p>Following the fusion and annotation of the model subgraph, the subsequent step involves generating customized C code aligned with the target ASIC driver and its corresponding API.</p>
<h2 id="lab-53-integration">Lab 5.3 - Integration</h2>
<p>To aid understanding, the diagram below depicts the full function call path for the code generation and data generation process as implemented in this lab.</p>
<h3 id="overview-of-c-codegen-in-python-version">Overview of C codegen in Python version</h3>
<p>In this lab, we implement a lightweight C code generator using Python, allowing for faster prototyping without the need to recompile TVM. This Python-based flow simplifies the integration of customized code generation logic while maintaining compatibility with the Relay model structure.</p>
<p>The codegen process is organized into three core components under <code>/Python/utils/*.py</code></p>
<ul>
<li><strong><code>codegen.py</code></strong>: Responsible for generating the full C source code required for model inference. This includes emitting function declarations and layer-wise computations, as well as embedding model weights.</li>
<li><strong><code>datagen.py</code></strong>: Handles the transformation of sample input datasets into a runtime-friendly binary format. A lightweight header is added to assist with input parsing during execution.</li>
<li><strong><code>note.py</code></strong>: Serves as a configuration and pattern-matching module. It defines wildcard variable names for pattern recognition and maps fused composite functions to their corresponding C code templates.</li>
</ul>
<p>This modular design not only increases code readability and reusability but also separates concerns clearly, making it easier to maintain and extend the system for different target hardware or model structures.</p>
<!--digraph G {
    node [shape=box, style=filled, fillcolor=lightgray];

    subgraph cluster_outer1{
        label = "build_model.py";
        style=filled;
        color=black;       // Border color
        penwidth=1;        // Makes the border more visible
        fillcolor=lightyellow;
        node [style=filled, fillcolor=white];

        subgraph cluster_inner1{
            label = "build_model()";
            style=filled;
            color=black;       // Border color
            penwidth=1;        // Makes the border more visible
            fillcolor=white;
            node [style=filled, fillcolor=white];

            relay_build [label="relay.build()"];
        }
        dataset_gen [label="dataset_gen"];
    }

    subgraph cluster_outer2{
        label = "datagen.py";
        style=filled;
        color=black;       // Border color
        penwidth=1;        // Makes the border more visible
        fillcolor=lightyellow;
        node [style=filled, fillcolor=white];
        subgraph cluster_inner2{
            label = "Dataset_Generator";
            style=filled;
            color=black;       // Border color
            penwidth=1;        // Makes the border more visible
            fillcolor="#E6E6FA";
            node [style=filled, fillcolor=white];

            gen_bin [label="gen_input_h()"];
            gen_float_array [label="gen_float_array()"];
            fetch_data [label="fetch_data()"];
        }
    }

    Compiler_space [label="Compiler Space"];

    subgraph cluster_outer3{
        label = "codegen.py";
        style=filled;
        color=black;       // Border color
        penwidth=1;        // Makes the border more visible
        fillcolor=lightyellow;
        node [style=filled, fillcolor=white];

        DLA_compiler [label="DLA_compiler()", fillcolor=lightblue];

        subgraph cluster_inner1{
            label = "CsourceCodegen";
            style=filled;
            color=black;       // Border color
            penwidth=1;        // Makes the border more visible
            fillcolor="#E6E6FA";
            node [style=filled, fillcolor=white];

            create_c_source_module [label = "create_c_source_module()"];
            get_c_func [label = "get_c_func()"];
        }

        subgraph cluster_inner2{
            label = "Ccodegen";
            style=filled;
            color=black;       // Border color
            penwidth=1;        // Makes the border more visible
            fillcolor="#E6E6FA";
            node [style=filled, fillcolor=white];

            jit [label = "jit()"];
            visit_expr [label = "visit_expr()"];


        }
    }

    subgraph cluster_outer4{
        label = "note.py";
        style=filled;
        color=black;       // Border color
        penwidth=1;        // Makes the border more visible
        fillcolor=lightyellow;
        node [style=filled, fillcolor=white];

        tvm_auto_args_NOTES [label="tvm_auto_args_NOTES {}", fillcolor=lightblue];
        tvm_c_func_call_gen  [label="tvm_c_func_call_gen {}", fillcolor=lightblue];

    }

    get_c_func -> jit;
    get_c_func -> visit_expr;
    visit_expr -> visit_expr;
    DLA_compiler -> get_c_func;
    DLA_compiler -> create_c_source_module;
    dataset_gen -> gen_bin;

    DLA_compiler -> Compiler_space [label=" (1) Register", style=dashed];

    relay_build -> Compiler_space [label=" (2) Find", style=dashed];
    Compiler_space -> relay_build [label=" (3)",style=dashed];
    relay_build -> DLA_compiler [label=" (4) Call", style=dashed];

    tvm_auto_args_NOTES -> visit_expr [label=" Get tensor info", style=dashed];
    tvm_c_func_call_gen -> visit_expr [label=" Get codegen function", style=dashed];
}-->

<p><img src="../../assets/svgs/lab5_graphviz_3.svg" alt="graphviz_3"></p>
<h3 id="tvm-relay-external-codegen-c-backend-walkthrough-codegenpy">TVM Relay External Codegen: C Backend Walkthrough - <code>codegen.py</code></h3>
<p>This part provides an explanation of the implementation for an external code generator in TVM targeting C. It demonstrates how to lower a Relay composite function into C code and generate a runtime-loadable module.</p>
<h4 id="module-overview-and-imports">Module Overview and Imports</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tvm</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.fuse</span><span class="w"> </span><span class="kn">import</span> <span class="n">COMPILER_NAME</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.fuse</span><span class="w"> </span><span class="kn">import</span> <span class="n">pattern_table</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.note</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span></code></pre></div>
<p>Here, standard TVM libraries are imported, along with local modules for pattern matching and annotations. The <code>COMPILER_NAME</code> defines the custom compiler target name used by TVM.</p>
<h4 id="data-structures-output-and-data">Data Structures: Output and Data</h4>
<h5 id="output">Output</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p><code>Output</code> is used to store metadata for generated buffers or variables, such as name, data type, copy requirements, and size.</p>
<h5 id="data">Data</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Data</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p><code>Data</code> stores information about constants, including their data content and structural metadata.</p>
<h4 id="abstract-codegen-base-class">Abstract Codegen Base Class</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CodegenCBase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This base class provides shared logic for all C-based code generators:</p>
<ul>
<li>Code string construction with indentation</li>
<li>Scope management for nested code</li>
<li>Wrapper function generation (<code>generate_backend_c_func</code>)</li>
<li>Runtime entry point generation (<code>jit_impl</code>)</li>
</ul>
<p>The output consists of both an internal kernel function and a wrapper conforming to TVM's external runtime interface.</p>
<h4 id="codegenc-core-relay-to-c-lowering">CodegenC: Core Relay to C Lowering</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CodegenC</span><span class="p">(</span><span class="n">CodegenCBase</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This class handles the traversal of the Relay IR and emits C code. It supports common Relay expressions including <code>Call</code>, <code>Var</code>, <code>Tuple</code>, <code>Constant</code>, and <code>TupleGetItem</code>.</p>
<h5 id="visiting-expressions">Visiting Expressions</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visit_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Var</span><span class="p">):</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_var</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">):</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_tuple</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">TupleGetItem</span><span class="p">):</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_tuple_get_item</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_constant</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Call</span><span class="p">):</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_call</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_expr_default</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span></code></pre></div>
<p>Becuase python did not support <strong>Overloadding</strong>, Relay expressions are dispatched to appropriate handlers depending on their type. For instance:</p>
<ul>
<li><code>visit_var</code>: Registers variable inputs.</li>
<li><code>visit_constant</code>: Processes embedded tensor data.</li>
<li><code>visit_call</code>: Handles composite patterns such as convolutions.</li>
</ul>
<h5 id="visiting-call-nodes-composite-operators">Visiting Call Nodes (Composite Operators)</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">visit_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This is the main entry point for lowering composite functions into backend-specific C calls. Key steps include:</p>
<ol>
<li>Check if the call is part of a known composite pattern.</li>
<li>Collect and process function arguments.</li>
<li>Allocate an output buffer for results.</li>
<li>Populate a config dictionary with all necessary parameters.</li>
<li>Emit a function call using a registered generator function.</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">visit_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>        <span class="n">composite_name</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Composite&quot;</span><span class="p">]</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>        <span class="n">func_name</span> <span class="o">=</span> <span class="n">composite_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="n">in_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">checked_type</span><span class="p">)</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>        <span class="k">if</span> <span class="n">composite_name</span> <span class="ow">in</span> <span class="n">PATTERN_TABLE</span><span class="p">:</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[composite trace]&quot;</span><span class="p">,</span> <span class="n">composite_name</span><span class="p">,</span> <span class="n">in_shape</span><span class="p">)</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unrecognized composite&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>First, obtain which Composite function this Call belongs to.
Next, replace "." with "_" in composite_name to convert it into a C-compatible function name.
Finally, retrieve the input shape of this Call.And check whether it exists in our pattern_table to prevent encountering unsupported functions.</p>
<p>Next, iterate through all parameters of the Call, checking whether each parameter is a constant (Constant) or a variable (Variable). Store these parameters for later use in generating C code.</p>
<p>Please complete the implementation of the trace parts, ensuring that operator information is correctly extracted and the corresponding C code is generated.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>        <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>        <span class="c1"># TODO 1: Trace parameters</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>        <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        <span class="c1"># For each argument in call.args, determine:</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="c1">#   - its mapped name in tvm_auto_args_NOTES[func_name]</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="c1">#   - whether it&#39;s a Constant or not</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="c1">#   - if not a constant, use `self.visit_expr(arg)` to visit it</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="c1"># Then fill the `parameters` dict like:</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="c1">#   parameters[&quot;input&quot;] = (value, is_const)</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="c1">#</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="c1"># Hint:</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="c1">#   - Use zip(call.args, tvm_auto_args_NOTES[func_name])</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="c1">#   - Use isinstance(arg, Constant)</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement argument tracing into the &#39;parameters&#39; dictionary.&quot;</span><span class="p">)</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="c1"># fetch function generator</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="n">func_gen</span> <span class="o">=</span> <span class="n">tvm_c_func_call_gen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">func_gen</span><span class="p">:</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>            <span class="k">return</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="c1"># if function generator not exist, just bypass the input.</span>
</span></code></pre></div>
<p>Next, set up the output buffer and store the parameters and values into the config for easy access later. Note that buf_idx should be incremented by 1 each time to ensure there are no duplicate buffers. Once the buffers are set, use get_conv_info(call) to retrieve the configuration and store it in the config.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>        <span class="c1"># output buffer</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>        <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>        <span class="c1"># TODO 2: Create output buffer</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="c1"># You need to:</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="c1">#   - Generate a new buffer name using `BUF_PREFIX` and self.buf_idx</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="c1">#   - Get the output buffer size: self.get_size(call)</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="c1">#   - Get the output buffer dtype: self.get_dtype_string(call.checked_type)</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="c1">#</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="c1"># You should generate a line like:</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="c1">#   float* out_0 = (float*)malloc(size * 4);</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="c1">#</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="c1"># Output:</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="c1">#   - out      -&gt; output buffer name</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="c1">#   - out_size -&gt; total number of elements</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="c1">#   - dtype    -&gt; C-style data type</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement output buffer allocation logic.&quot;</span><span class="p">)</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>        <span class="c1">### gether the parameter that we need.</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>        <span class="c1"># conv2d Op info</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="k">if</span> <span class="s2">&quot;conv2d&quot;</span> <span class="ow">in</span> <span class="n">func_name</span><span class="p">:</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conv_info</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>            <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="c1"># wildcard info</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span><span class="s2">&quot;bias&quot;</span><span class="p">]:</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>            <span class="c1"># default</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>            <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>            <span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>            <span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>            <span class="c1"># get parameter</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>            <span class="n">param</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>            <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>                <span class="k">continue</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>            <span class="c1"># unpack</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="n">p</span><span class="p">,</span><span class="n">is_const</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>                <span class="k">continue</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>            <span class="c1"># if it is constant, now can visit it</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>            <span class="k">if</span> <span class="n">is_const</span><span class="p">:</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_constant</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>            <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>            <span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>            <span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_size</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>        <span class="c1"># convert quntize scale</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span><span class="n">is_const</span><span class="p">)</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>            <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">is_const</span><span class="p">:</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>                <span class="n">config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>        <span class="c1"># malloc output buffer</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>        <span class="n">buf_create</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2"> = (</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">*)malloc(</span><span class="si">{</span><span class="n">out_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="si">}</span><span class="s2">);&quot;</span>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ext_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf_create</span><span class="p">)</span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>        <span class="c1"># generate c function</span>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ext_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">func_gen</span><span class="p">(</span><span class="n">config</span><span class="p">)))</span>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a>
</span><span id="__span-14-68"><a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>        <span class="c1"># free input buffer</span>
</span><span id="__span-14-69"><a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>        <span class="n">p</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
</span><span id="__span-14-70"><a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>        <span class="k">if</span> <span class="n">BUF_PREFIX</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="__span-14-71"><a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a>            <span class="n">buf_free</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;free(</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">);&quot;</span>
</span><span id="__span-14-72"><a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ext_func_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf_free</span><span class="p">)</span>
</span><span id="__span-14-73"><a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>
</span><span id="__span-14-74"><a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">need_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">out_size</span><span class="p">)</span>
</span><span id="__span-14-75"><a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="p">]</span>
</span></code></pre></div>
<h5 id="extracting-convolution-information">Extracting Convolution Information</h5>
<p>To extract convolution-related parameters (e.g., padding, kernel size, and number of output channels), the <code>get_conv_info</code> function performs a <strong>Breadth-First Search (BFS)</strong> over the body of the composite function. It starts by initializing a <code>conv2d_info</code> dictionary with default values and adds the top-level operation (<code>call.op.body</code>) to the <code>op_list</code>. As it iterates through this list, it checks if each node is a Call and whether its operator name is "<code>nn.conv2d</code>". If a convolution is found, it extracts and stores the relevant attributes—such as <code>padding</code>, <code>channels</code>, and <code>kernel_size</code>—into the conv2d_info dictionary. This approach ensures that deeply nested operators inside fused composite patterns are correctly identified and their parameters recorded for downstream code generation.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conv_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">call</span><span class="p">):</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>        <span class="n">op_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">body</span><span class="p">,]</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="n">conv2d_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>            <span class="s2">&quot;m&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_m&quot;</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>            <span class="s2">&quot;e&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_e&quot;</span><span class="p">,</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>            <span class="s2">&quot;p&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_p&quot;</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>            <span class="s2">&quot;q&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_q&quot;</span><span class="p">,</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>            <span class="s2">&quot;r&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_r&quot;</span><span class="p">,</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>            <span class="s2">&quot;t&quot;</span><span class="p">:</span><span class="s2">&quot;DEFAULT_t&quot;</span><span class="p">,</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>            <span class="s2">&quot;U&quot;</span><span class="p">:</span><span class="mi">1</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="p">}</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="c1"># BFS</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="n">op</span> <span class="o">=</span> <span class="n">op_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>            <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>            <span class="c1"># TODO: Extract conv2d attributes from the op node</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>            <span class="c1"># ------------------------------------------------------------</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>            <span class="c1"># If the op is nn.conv2d:</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>            <span class="c1">#   - Extract and store:</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>            <span class="c1">#       - padding -&gt; conv2d_info[&quot;PAD&quot;]</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>            <span class="c1">#       - channels -&gt; conv2d_info[&quot;M&quot;]</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>            <span class="c1">#       - kernel size (0 and 1) -&gt; conv2d_info[&quot;R&quot;], conv2d_info[&quot;S&quot;]</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>            <span class="c1">#   - Also set conv2d_info[&quot;m&quot;] = conv2d_info[&quot;M&quot;]</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>            <span class="c1">#</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>            <span class="c1"># Hint:</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            <span class="c1">#   - Use op.op.name to check for &quot;nn.conv2d&quot;</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            <span class="c1">#   - Use op.attrs[&quot;padding&quot;], op.attrs[&quot;channels&quot;], etc.</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>            <span class="c1">#   - You can assume padding and kernel_size are lists/tuples.</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>            <span class="c1">#</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>            <span class="c1"># Example:</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>            <span class="c1">#   conv2d_info[&quot;PAD&quot;] = op.attrs[&quot;padding&quot;][0]</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            <span class="c1"># When done, remove the following line</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You need to extract attributes for nn.conv2d node.&quot;</span><span class="p">)</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Call</span><span class="p">):</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>                    <span class="n">op_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        <span class="k">return</span> <span class="n">conv2d_info</span>
</span></code></pre></div>
<p>This is essential for generating hardware-aware kernel configurations.</p>
<h4 id="code-emission-and-constant-handling">Code Emission and Constant Handling</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_data_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">const_id</span><span class="p">,</span> <span class="n">cn</span><span class="p">):</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>Each constant is given a unique name and stored for emission into <code>weight.c</code> and <code>weight.h</code>.</p>
<p>The <code>visit_constant</code> method also returns an <code>Output</code> object representing the constant as a pointer for runtime use.</p>
<h4 id="csourcecodegen-final-module-construction">CSourceCodegen: Final Module Construction</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CSourceCodegen</span><span class="p">(</span><span class="n">CSourceModuleCodegenBase</span><span class="p">):</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This class wraps everything and produces:</p>
<ul>
<li><code>code.c</code>: Generated logic for the Relay function.</li>
<li><code>weight.c</code>/<code>weight.h</code>: Definitions and initializations for constant data.</li>
<li><code>weight.bin</code>: Serialized tensor weights.</li>
</ul>
<h5 id="generating-the-function">Generating the Function</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">gen_c_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>Calls into <code>CodegenC</code> to perform expression traversal and lower the function. The resulting C source code is appended to the <code>code_stream</code>.</p>
<h5 id="generating-weight-files">Generating Weight Files</h5>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">gen_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">const_vars</span><span class="p">):</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>Iterates through all constants, exports their data to:</p>
<ul>
<li>C array declarations (<code>weight.c</code>)</li>
<li>Header file references (<code>weight.h</code>)</li>
<li>A binary blob file for deployment (<code>weight.bin</code>)</li>
</ul>
<p>Special handling is included for DLA platforms that require channel padding to multiples of 4.</p>
<h4 id="tvm-registration">TVM Registration</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_func</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;relay.ext.</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">DLA_compiler</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>This function is registered under the name <code>relay.ext.&lt;compiler&gt;</code> and invoked automatically when TVM detects a composite pattern assigned to the external compiler.</p>
<h4 id="output-files">Output Files</h4>
<p>Upon execution, the following files are written to <code>./output/</code>:</p>
<ul>
<li><code>code.c</code>: Core runtime logic</li>
<li><code>weight.c</code>: Constant data arrays</li>
<li><code>weight.h</code>: Header declarations for constants</li>
<li><code>weight.bin</code>: Serialized constant tensors for loading at runtime</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">dump_code</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_c_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="dataset-preprocessing-for-c-deployment-datagenpy">Dataset Preprocessing for C Deployment - <code>datagen.py</code></h3>
<p>In this section, we walk through the implementation of <code>datagen.py</code>, which prepares dataset samples for use in embedded C environments. Its primary function is to <strong>retrieve images from a test dataset</strong> and convert them into <code>.h</code> (C header) or <code>.bin</code> (binary) files, making them portable for inference testing on microcontrollers or other low-level platforms.</p>
<h4 id="data-processing-class-overview">Data Processing Class Overview</h4>
<p>We start by defining a class called <code>Dataset_Generator</code>, which handles the core data preprocessing logic. Its responsibilities include:</p>
<ul>
<li>Loading the test dataset</li>
<li>Extracting a specified number of test samples per category</li>
<li>Generating C-style <code>.h</code> files</li>
<li>Generating binary <code>.bin</code> files</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Dataset_Generator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">eval_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_transform</span> <span class="o">=</span> <span class="n">eval_transform</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>            <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>            <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>            <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>            <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_transform</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        <span class="p">)</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></code></pre></div>
<h4 id="fetching-data-by-class">Fetching Data by Class</h4>
<p>The <code>fetch_data()</code> method extracts a fixed number of samples (<code>num_data_per_class</code>) from each category in the test dataset and organizes them into a dictionary for later processing.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_data_per_class</span><span class="p">):</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">classes</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">):</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>            <span class="n">data_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="p">:</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>                    <span class="n">data_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">num_data_per_class</span><span class="p">:</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>                    <span class="k">break</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>        <span class="k">return</span> <span class="n">data_dict</span>
</span></code></pre></div>
<h4 id="generating-bin-files">Generating .bin Files</h4>
<p>The <code>gen_bin()</code> method saves the extracted image data to a <code>.bin</code> file in a format suitable for embedded inference. The binary structure includes:</p>
<ol>
<li>Total number of classes</li>
<li>Each class name and its length (encoded in UTF-8)</li>
<li>Number of samples per class</li>
<li>Flattened image size</li>
<li>The actual image data in <code>float32</code> format</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gen_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">num_data_per_class</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>        <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">num_data_per_class</span><span class="o">=</span><span class="n">num_data_per_class</span><span class="p">)</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>  <span class="c1"># Total number of classes</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>                <span class="n">encoded_name</span> <span class="o">=</span> <span class="n">class_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>                <span class="n">name_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_name</span><span class="p">)</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">name_length</span><span class="p">))</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encoded_name</span><span class="p">)</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>            <span class="n">first_data_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>            <span class="n">flattened_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">first_data_shape</span><span class="p">)</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">num_data_per_class</span><span class="p">))</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">flattened_size</span><span class="p">))</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>                    <span class="n">np_array</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">np_array</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
</span></code></pre></div>
<h3 id="tvm-function-call-generation-for-quantized-inference-notepy">TVM Function Call Generation for Quantized Inference - <code>note.py</code></h3>
<p>This module automates the generation of C-style function call code for the <strong>TVM (Tensor Virtual Machine)</strong> compiler. It targets <strong>quantized deep learning models</strong> and supports operations such as:</p>
<ul>
<li>Quantized Convolution (<code>QConv2D</code>)</li>
<li>Quantized Linear Layer (<code>QLinear</code>)</li>
<li>Quantization / Dequantization</li>
<li>Variants like ReLU and MaxPooling fused with other ops</li>
</ul>
<h4 id="tvm_auto_args_notes-parameter-schemas-for-tvm-operations"><code>tvm_auto_args_NOTES</code>: Parameter Schemas for TVM Operations</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">tvm_auto_args_NOTES</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">_qconv2d_relu_maxpool&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>        <span class="s2">&quot;input&quot;</span><span class="p">,</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>        <span class="s2">&quot;input_scale&quot;</span><span class="p">,</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>        <span class="s2">&quot;input_zero_point&quot;</span><span class="p">,</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="s2">&quot;weight_scale&quot;</span><span class="p">,</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="s2">&quot;weight_zero_point&quot;</span><span class="p">,</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="s2">&quot;bias&quot;</span><span class="p">,</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>        <span class="s2">&quot;bias_scale&quot;</span><span class="p">,</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="s2">&quot;bias_zero_point&quot;</span><span class="p">,</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="s2">&quot;dequantize_scale&quot;</span><span class="p">,</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>        <span class="s2">&quot;dequantize_zero_point&quot;</span><span class="p">,</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>        <span class="s2">&quot;quantize_zero_point&quot;</span><span class="p">,</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>    <span class="p">],</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>    <span class="c1"># Additional entries go here</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>This dictionary defines the <strong>expected argument names</strong> for each supported TVM function. These names will be used for:</p>
<ul>
<li>Identifying input/output tensors</li>
<li>Associating quantization parameters (scales, zero points)</li>
<li>Mapping configurations for code generation</li>
</ul>
<p>For example, the <code>qconv2d_relu_maxpool</code> function requires:</p>
<ul>
<li><strong>Input, Weights, Biases</strong> (quantized)</li>
<li><strong>Quantization/Dequantization scales and zero points</strong></li>
<li><strong>Dequantize/Quantize metadata for rescaling output</strong></li>
</ul>
<h4 id="convert_log-helper-for-quantization-scaling"><code>convert_log</code>: Helper for Quantization Scaling</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_log</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="k">return</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></code></pre></div>
<p>This helper function calculates <code>-log2(x)</code> as an integer.
It’s commonly used to transform floating-point scaling factors into <strong>integer log scale shifts</strong>, which are more efficient for fixed-point inference on hardware accelerators or microcontrollers.</p>
<h4 id="tvm_c_func_call_gen-c-code-generators-per-operator"><code>tvm_c_func_call_gen</code>: C Code Generators per Operator</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">tvm_c_func_call_gen</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">COMPILER_NAME</span><span class="si">}</span><span class="s2">_qconv2d_relu_maxpool&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="s2">#ifndef CPU_ONLY</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="s2">  qconv2d_relu_maxpool(</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="s2">#else</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="s2">  qconv2d_relu_maxpool_cpu(</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="s2">#endif</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="s2">    </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="s2">    </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_len&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_len&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;weight_len&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="s2">#ifndef CPU_ONLY</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="s2">    // Mapping parameters</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="s2">    </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="s2">#endif</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="s2">    // Shape parameters</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="s2">    </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PAD&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="s2">    </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="s2">    // Quantization scale</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="s2">    </span><span class="si">{</span><span class="n">convert_log</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_scale&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;weight_scale&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dequantize_scale&quot;</span><span class="p">])</span><span class="si">}</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="s2">  );</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>    <span class="c1"># Additional entries go here</span>
</span></code></pre></div>
<p>This dictionary maps each TVM operation to a corresponding <strong>C-language function call template</strong>, dynamically filled using the <code>config</code> dictionary.</p>
<p>Each lambda returns a formatted multi-line C function call string, ready to be inserted into generated code. These templates can target:
- CPU-only versions (<code>*_cpu</code>)
- Normal hardware-accelerated (DLA) versions</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<h5 id="example-output">Example Output:</h5>
<div class="language-C++ highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">qconv2d_relu_maxpool</span><span class="p">(</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="n">bias</span><span class="p">,</span><span class="w"> </span><span class="n">output_len</span><span class="p">,</span><span class="w"> </span><span class="n">input_len</span><span class="p">,</span><span class="w"> </span><span class="n">weight_len</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="c1">// mapping parameter</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="c1">// shape parameter</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="n">PAD</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">,</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="c1">// quantize scale</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="n">convert_log</span><span class="p">(</span><span class="n">input_scale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">weight_scale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dequantize_scale</span><span class="p">)</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="p">);</span>
</span></code></pre></div>
</div>
<p>Once all python script are completed, the <code>build_model</code> logic will automatically invoke the appropriate code generation logic from <code>tvm_c_func_call_gen</code>, completing the full compilation and code-emission process for quantized models.</p>
<h2 id="lab-54-performance-analysis">Lab 5.4 - Performance Analysis</h2>
<p>In this lab, we will explore tools that help analyze and visualize memory usage during program execution. We will use Valgrind’s Massif toolset to profile a simple C program that recursively prints Fibonacci numbers.</p>
<h3 id="massif-heap-memory-profiler"><code>massif</code>: Heap Memory Profiler</h3>
<p>Massif is a heap profiler provided by Valgrind. It helps track memory allocations, identify memory peaks, and analyze memory usage over time.</p>
<p>To use Massif, run the following command in the <code>lab</code> directory:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>make<span class="w"> </span>massif
</span></code></pre></div>
<p>This will execute the program <code>massif_test</code>, which prints a list of Fibonacci numbers using a recursive function.</p>
<p>Massif will trace memory usage at runtime. Internally, it uses the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>valgrind<span class="w"> </span>--tool<span class="o">=</span>massif<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span>--heap<span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">  </span>--stacks<span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">  </span>--time-unit<span class="o">=</span>i<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span>--detailed-freq<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">  </span>--max-snapshots<span class="o">=</span><span class="m">1000</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">  </span>--massif-out-file<span class="o">=</span>massif.out.massif_test<span class="w"> </span>./massif_test
</span></code></pre></div>
<p>Example output:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>==841727== Massif, a heap profiler
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>==841727== Command: ./massif_test
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Fibonacci sequence:
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>0 1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>Memory released.
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The prefix <code>==841727==</code> refers to the process ID (PID) of the running program.</p>
</div>
<h3 id="ms_print-text-based-memory-usage-graph"><code>ms_print</code>: Text-Based Memory Usage Graph</h3>
<p>ms_print is a command-line tool that reads the Massif output and displays a detailed memory usage graph.</p>
<p>To generate a visual report:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>make<span class="w"> </span>ms_print
</span></code></pre></div>
<p>This will use <code>ms_print</code> to parse the output file <code>massif.out.massif_test</code> and dump the results into <code>massif_output.txt</code>.</p>
<p>Here's a sample snippet of the memory usage chart:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>Command:            ./massif_test
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>Massif arguments:   --heap=yes --stacks=yes --time-unit=i --detailed-freq=1 --max-snapshots=1000 --massif-out-file=massif.out.massif_test
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>ms_print arguments: massif.out.massif_test
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    KB
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>7.219^   #
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>     |   #
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>     |   #
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>     |   #
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>     |   #
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>     |   #
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>     |   #@
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>     |   #@
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>     |   #@
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>     |   #@
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>     |   #@
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>     |   #@
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>     |   #@                                                                 @@
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>     |   #@                                                                 @@
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>     |   #@                                                                 @@
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>     |   #@                                                                 @@
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>     |   #@  @@@@@@                                                         @@
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>     |   #@ @@@@@@@             @        @            @ @@ @                @@
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>     |   #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>     |@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>   0 +-----------------------------------------------------------------------&gt;ki
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a>     0                                                                   783.4
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>Number of snapshots: 533
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a> Detailed snapshots: [0, 1, 2, 3, 4, 5, 6 (peak), 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 461, 462, 463, 464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532]
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>  n        time(i)         total(B)   useful-heap(B) extra-heap(B)    stacks(B)
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>  0              0                0                0             0            0
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>00.00% (0B) (heap allocation functions) malloc/new/new[], --alloc-fns, etc.
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a>  n        time(i)         total(B)   useful-heap(B) extra-heap(B)    stacks(B)
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a>--------------------------------------------------------------------------------
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a>  1          1,568              400                0             0          400
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>00.00% (0B) (heap allocation functions) malloc/new/new[], --alloc-fns, etc.
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>... more spanshots
</span></code></pre></div>
<p>It includes:</p>
<ul>
<li>Memory peaks and detailed timeline</li>
<li>Number of snapshots (memory samples taken)</li>
<li>Stack vs heap usage breakdown</li>
</ul>
<h3 id="massif-visualizer-gui-for-massif-output"><code>massif-visualizer</code>: GUI for Massif Output</h3>
<p><strong>massif-visualizer</strong> is a graphical interface for visualizing Massif output, making it easier to analyze memory usage trends interactively.</p>
<h4 id="to-use-massif-visualizer">To use <code>massif-visualizer</code>:</h4>
<ol>
<li>Ensure <strong>X11 forwarding</strong> is enabled if you're using SSH.</li>
<li>Launch the tool:</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>massif-visualizer
</span></code></pre></div>
<ol>
<li>Open the output file:</li>
<li>Click <strong>Open...</strong>
   <img alt="Open Massif Visualizer" src="../../assets/images/BJtaDetkgl.png" /></li>
<li>
<p>Choose <code>massif.out.massif_test</code>
   <img alt="Open files" src="../../assets/images/Bkw7ueYkll.png" /></p>
</li>
<li>
<p>View the memory usage graph:
   <img alt="Massif Graph" src="../../assets/images/r14cueFJgx.png" /></p>
</li>
</ol>
<p>This visualization helps you easily pinpoint memory-intensive regions and track memory growth over time.
There are also gui application called <code>massif-visualizer</code>, it is...</p>
<h4 id="clean-up">Clean Up</h4>
<p>After completing the lab, clean the generated output files by running:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>make<span class="w"> </span>clean
</span></code></pre></div>
<p>This removes all intermediate files and prepares the environment for a fresh start.</p>
<h2 id="practice">Practice</h2>
<p>In this lab, you learned how to build a complete AI compiler flow that translates high-level machine learning models into low-level C code suitable for embedded and CPU-only environments. You explored key compiler components such as <strong>Relay operator fusion</strong>, <strong>external code generation</strong>, and <strong>performance analysis</strong> using memory profiling tools like <code>valgrind</code>, <code>massif</code>, and <code>ms_print</code>.</p>
<p>In addition, you will implement and complete several essential modules of the compiler pipeline, including:</p>
<ul>
<li>Writing pattern-matching functions for <strong>operator fusion</strong> in <code>fuse.py</code>.</li>
<li>Completing <strong>code generation logic</strong> in <code>note.py</code> for different quantized operators.</li>
<li>Generating appropriate function calls based on Relay transformations.</li>
<li>Performing <strong>memory profiling</strong> on recursive functions using Massif, and interpreting the results through both CLI (<code>ms_print</code>) and GUI (<code>massif-visualizer</code>).</li>
</ul>
<p>These tasks are designed to help you understand the end-to-end compilation and deployment process of deep learning models, and how software optimization maps to hardware-aware execution models.</p>
<p>By the end of this assignment, you will have hands-on experience with:</p>
<ul>
<li>Translating Relay models into fused representations</li>
<li>Implementing target-specific code generators</li>
<li>Profiling and analyzing memory usage at runtime</li>
</ul>
<p>Make sure to follow the implementation notes and fill in the TODOs as marked by the TAs in each respective file.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Before starting the lab, make sure the following setup steps are completed:</p>
<ol>
<li>
<p><strong>Download and extract the lab materials</strong>
   Get the sample code and report template from Moodle, then decompress the archive:
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>unzip<span class="w"> </span>aoc2025-lab5.zip
</span></code></pre></div></p>
</li>
<li>
<p><strong>Activate the lab environment</strong>
   Ensure that you are working in the correct Conda environment for this lab:
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>conda<span class="w"> </span>activate<span class="w"> </span>tvm-lab
</span></code></pre></div></p>
</li>
</ol>
<h3 id="directory-structure">Directory Structure</h3>
<p>After unzipped the file downloaded from Moodle, the directory structure will look like below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>StudentID_lab5
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>├── Csource
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>│   ├── color.h
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>│   ├── input.c
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>│   ├── input.h
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>│   ├── utils.c
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>│   └── utils.h
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>├── lab
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>│   ├── makefile
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>│   └── massif_test.c
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>├── Makefile
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>├── model
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>│   └── alexnetbn_v2-power2.onnx
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>├── Python
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>│   ├── build_model.py
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>│   ├── utils
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>│   └── VisuTVM
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>├── report.md
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>├── simulation
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>│   ├── hardware
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>│   └── software
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>└── testbench
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>    ├── cpu
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>    └── dla
</span></code></pre></div>
<h3 id="1-codegen-with-tvm-compiler">1. Codegen with TVM compiler</h3>
<p>Implement the section in the following python files</p>
<ol>
<li>
<p><code>fuse.py</code>
<div class="language-python highlight"><span class="filename">fuse.py</span><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">fuse_conv2d_bias_add_relu</span><span class="p">():</span><span class="o">...</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">fuse_dense_add_relu</span><span class="p">():</span><span class="o">...</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">fuse_dense_add</span><span class="p">():</span><span class="o">...</span>
</span></code></pre></div></p>
</li>
<li>
<p><code>codegen.py</code>
<div class="language-python highlight"><span class="filename">codegen.py</span><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">visit_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span><span class="o">...</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_conv_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">call</span><span class="p">):</span><span class="o">...</span>
</span></code></pre></div></p>
</li>
<li>
<p><code>datagen.py</code></p>
</li>
<li>
<p><code>tvm_c_func_call_gen/note.py</code>
<div class="language-python highlight"><span class="filename">tvm_c_func_call_gen/note.py</span><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">tvm_c_func_call_gen</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>    <span class="o">...</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="p">}</span>
</span></code></pre></div></p>
</li>
</ol>
<p>Once you have completed the marked sections above, you can proceed to execute the following steps in order.</p>
<h4 id="build-the-model">Build the model</h4>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>make<span class="w"> </span>build_model
</span></code></pre></div>
<ul>
<li>This command will:<ol>
<li>load model from onnx format, convert to relay model.</li>
<li>parse and fused the relay model, and dump relay model expresion to text file.(Used in visuTVM)</li>
<li>Build the model in python script, including traverse composited model, C code generation, weight generation.</li>
<li>Parse the CIFAR10 dataset, and convert to custom input binary file.</li>
<li>extract the tar generate from TVM, and categorize them into different folders.
The Process will traverse the hale model in DFS order, notice that the trace flow is from output layer back to input layer.</li>
</ol>
</li>
</ul>
<h4 id="visutvm-relay-graph-visualizer">visuTVM: Relay Graph Visualizer</h4>
<p><code>visuTVM</code> is a tool used to visualize the structure of a TVM Relay model graph, helping you better understand model transformations during compilation.</p>
<p>To generate visualizations of the Relay graph:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>make<span class="w"> </span>visuTVM
</span></code></pre></div>
<p>This command produces two SVG images representing the Relay graph:</p>
<ul>
<li><code>./output/visu_VGG8_relay_ir.svg</code>: The original Relay IR (before the MergeComposite pass)</li>
<li><code>./output/visu_VGG8_relay_ir_pass.svg</code>: The Relay IR after pattern fusion and annotation passes</li>
</ul>
<h3 id="2-simulation-and-performance-analysis">2. Simulation and Performance Analysis</h3>
<p>In this task, you will analyze the memory usage and runtime performance of the CPU-only version of your model using <strong>Massif</strong>, a heap memory profiler from Valgrind. Additionally, you will utilize <strong>DLA info counters</strong>—provided in the Lab 4 runtime library—to evaluate the behavior and efficiency of the simulated accelerator.</p>
<p>This dual analysis allows you to compare software-based and hardware-like execution, providing deeper insights into memory bottlenecks and inference performance.</p>
<h4 id="inference-model-with-cpu-only">Inference model with CPU-only</h4>
<p>For quickly demo and test of cpu version:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>make<span class="w"> </span>test_cpu
</span></code></pre></div>
<p>you will got a single shot of inference of full model in cpu-only runtime api.</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>CC<span class="w"> </span>weight.o
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>CC<span class="w"> </span>input.o
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>CC<span class="w"> </span>utils.o
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>CC<span class="w"> </span>runtime_cpu.o
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>CC<span class="w"> </span>hardware_cpu.o
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>CXX<span class="w"> </span>main.o
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>CXX<span class="w"> </span>model.o
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>LD<span class="w"> </span>main
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Leaving<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/aoc2025/n26130605/work/lab5/testbench/cpu&#39;</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>/home/aoc2025/n26130605/work/lab5
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>Running<span class="w"> </span>program...
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/aoc2025/n26130605/work/lab5/testbench/cpu&#39;</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>log
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>Run<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="o">===============[</span><span class="w"> </span>single<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="o">]===============</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>Input<span class="w"> </span>file:<span class="w"> </span>../../output/bin/input.bin
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>Weight<span class="w"> </span>file:<span class="w"> </span>../../output/bin/weight.bin
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>Class<span class="w"> </span>index:<span class="w"> </span><span class="m">4</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>Image<span class="w"> </span>index:<span class="w"> </span><span class="nv">9</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="o">=============================================</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>Image<span class="w"> </span>Test:<span class="w"> </span><span class="m">9</span>/10<span class="w"> </span>image<span class="w"> </span>class<span class="w">         </span><span class="nv">deer</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="o">=============================================</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="o">[</span><span class="w">    </span>airplane<span class="o">]</span><span class="w">   </span><span class="m">5</span>.203%
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="o">[</span><span class="w">  </span>automobile<span class="o">]</span><span class="w">   </span><span class="m">0</span>.058%
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="o">[</span><span class="w">        </span>bird<span class="o">]</span><span class="w">   </span><span class="m">0</span>.621%
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="o">[</span><span class="w">         </span>cat<span class="o">]</span><span class="w">   </span><span class="m">0</span>.333%
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="o">[</span><span class="w">        </span>deer<span class="o">]</span><span class="w">  </span><span class="m">20</span>.578%
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="o">[</span><span class="w">         </span>dog<span class="o">]</span><span class="w">   </span><span class="m">0</span>.484%
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="o">[</span><span class="w">        </span>frog<span class="o">]</span><span class="w">   </span><span class="m">0</span>.058%
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="o">[</span><span class="w">       </span>horse<span class="o">]</span><span class="w">  </span><span class="m">71</span>.826%
</span><span id="__span-45-33"><a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="o">[</span><span class="w">        </span>ship<span class="o">]</span><span class="w">   </span><span class="m">0</span>.090%
</span><span id="__span-45-34"><a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a><span class="o">[</span><span class="w">       </span>truck<span class="o">]</span><span class="w">   </span><span class="m">0</span>.750%
</span><span id="__span-45-35"><a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a><span class="o">=============================================</span>
</span><span id="__span-45-36"><a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a>make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Leaving<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/aoc2025/n26130605/work/lab5/testbench/cpu&#39;</span>
</span></code></pre></div>
For more config in compiling cpu-only version runtime, move into <code>testbench/cpu</code>, then use <code>make usage</code> for more details about configurations.
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>cd testbench/cpu
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>make usage
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>Usage: make [target]
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>Available targets:
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>  all                      - Build the project (default target)
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>  test     [CLASS][INDEX]  - Run the compiled executable with test input
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>  valgrind [CLASS][INDEX]  - Run Valgrind Massif to analyze memory usage
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>  test_full                - Run with 100 test input
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>  valgrind_full            - Run Valgrind Massifwith 100 test input
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>  clean                    - Remove all generated files
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>Environment Variables:
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>  CLASS=&lt;num&gt;   - Set class index for testing (default: 4)
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>  INDEX=&lt;num&gt;   - Set test index (default: 9)
</span></code></pre></div></p>
<p>Notice that it is needed to <code>make clean</code> before any new configuration applied.
- <code>make test</code> is the single shot of indecated image.
- <code>make test_full</code> will implement 100 images.
    <div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>================[ full test ]================
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>Input file: ../../output/bin/input.bin
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>Weight file: ../../output/bin/weight.bin
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>=============================================
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>&#39;.&#39; is PASS,&#39;&lt;num&gt;&#39; is the wrong prediction
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>=============================================
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>[ 0 -        airplane]  . . 2 . . 9 . . . .
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>[ 1 -      automobile]  . 9 9 . . . . . . .
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>[ 2 -            bird]  . 3 . . . . . . . 5
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>[ 3 -             cat]  . . . . . . . . . .
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>[ 4 -            deer]  . . . . . 5 . . . 7
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>[ 5 -             dog]  . . . . . . . . . 3
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>[ 6 -            frog]  . . . . . . . . . 4
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>[ 7 -           horse]  . . . . . 3 . . . 4
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>[ 8 -            ship]  . . 6 . . . . . . .
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>[ 9 -           truck]  . . . . . . . . . .
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>Correct/Total: 87/100
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>=============================================
</span></code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">Model Accuracy</p>
<p>After quantization, it achieves 88.xx% accuracy on the CIFAR-10 dataset.
This means that the results seen in this simulation make sense!</p>
</div>
<h4 id="memory-usage-analysis-with-massif">Memory Usage Analysis with Massif</h4>
<ul>
<li><code>make valgrind</code> and <code>make valgrind_full</code> execute the same tests as <code>make test</code>, but with enhanced memory tracking during runtime.</li>
<li>These commands utilize the <strong>Valgrind Massif</strong> tool to monitor and trace memory usage, saving the output in the <code>massif_out/</code> directory.</li>
<li>To visualize and analyze memory usage over time, use <strong>massif-visualizer</strong> to open the generated output files.</li>
</ul>
<h4 id="inference-model-with-dla">Inference model with DLA</h4>
<p>In DLA version test and demo, use <code>make test_dla</code> at top directory will perform a single shot simulation on eyeriss ASIC.</p>
<ul>
<li>it will takes frew more seconeds to simulation.
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>Run test
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>=============================================
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>Input file: ../../output/bin/input.bin
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>Weight file: ../../output/bin/weight.bin
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>Class index: 4
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>Image index: 9
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>=============================================
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>Image Test: 9/10 image class         deer
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>=============================================
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>[    airplane]   5.203%
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>[  automobile]   0.058%
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>[        bird]   0.621%
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>[         cat]   0.333%
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>[        deer]  20.578%
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>[         dog]   0.484%
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>[        frog]   0.058%
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>[       horse]  71.826%
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>[        ship]   0.090%
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>[       truck]   0.750%
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>=============================================
</span></code></pre></div></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Model Misclassification</p>
<p>Occasional misclassifications can occur. For example, in the case above, the model mistakenly identified a <code>deer</code> as a <code>horse</code>.</p>
</div>
<p>Also, for more information and configuraion about DLA version compile and inference is in <code>testbench/dla</code>, use <code>make usage</code> to get details about them.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>cd testbench/dla
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>make usage
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>Usage: make [target]
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>Available targets:
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>  all  [DEBUG=?][DLA_INFO=?][USE_VCD=?]      - Build the project (default target)
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>  test [CLASS=&lt;num&gt;][INDEX=&lt;num&gt;]            - Run the compiled executable with test input
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>  clean      - Remove all generated files
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>  nWave      - Launch nWave with logs
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>Environment Variables:
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>  DEBUG=1       - Enable debug mode
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>  DLA_INFO=1    - Enable DLA info logs
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>  USE_VCD=1     - Enable VCD dumping
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>  CLASS=&lt;num&gt;   - Set class index for testing (default: 4)
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>  INDEX=&lt;num&gt;   - Set test index (default: 9)
</span></code></pre></div>
<div class="admonition note important">
<p class="admonition-title">Note</p>
<p>Notice that the DLA version did not support <code>test_full</code>, because the 100 images simulation will takes more than one hours, even run on better computer.</p>
</div>
<h4 id="dla-runtime-analysis">DLA runtime analysis</h4>
<p>To enable this feature, set the environment variable <code>DLA_INFO=1</code> before running make test. After the test completes, a CSV file will be generated containing statistics and parameters for each task assigned to the DLA.</p>
<ol>
<li>Run inference on a single image using DLA simulation, and export the statistics as a CSV file. The statistics should include <strong>cycle count</strong>, <strong>time</strong> and <strong>memory read/write count</strong> for each layer.
<pre class="mermaid"><code>%%{init: {
    "themeVariables": {
        "xyChart": {
        "plotColorPalette": "#17b55e"
        }
    }
    }}%%
xychart-beta
    title "Example Chart"
    x-axis ["layer 1", "layer 2", "layer 3", "layer 4", "layer 5"]
    y-axis "Y-axis" 20 --&gt; 300
    bar [100, 234, 213, 167, 80]</code></pre></li>
<li>Compare the results with the predicted values from Lab 2. Do the statistics align with the predictions? If there are discrepancies, where might estimation and actual experimental results diverge? (This is an open-ended question—any reasonable explanation is acceptable.)</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">VS Code Extension - Markdown Preview Mermaid</p>
<p>This extension allows you to preview Mermaid diagrams directly in Markdown files.
<img alt="Preview Screenshot" src="../../assets/images/Hkc4zjcJle.png" /></p>
</div>
<h3 id="clean-up_1">Clean Up</h3>
<ol>
<li>To remove output logs and executables in a specific module, run <code>make clean</code> inside <code>testbench/cpu</code> or <code>testbench/dla</code>.</li>
<li>To clean up everything, including generated code and testbench executables, run <code>make clean</code> in the root directory of the lab project.</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab4/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lab 4 - Runtime and Performance Profiling">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Lab 4 - Runtime and Performance Profiling
              </div>
            </div>
          </a>
        
        
          
          <a href="../../developers/" class="md-footer__link md-footer__link--next" aria-label="Next: Developer Guides">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Developer Guides
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/NCKU-AISLAB/force-ai" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.path", "navigation.top", "navigation.footer", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js"></script>
      
    
  </body>
</html>