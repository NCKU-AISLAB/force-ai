
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab3/">
      
      
        <link rel="next" href="../lab5/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Lab 4 - Runtime and Performance Profiling - FORCE AI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-4-runtime-and-performance-profiling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="FORCE AI" class="md-header__button md-logo" aria-label="FORCE AI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FORCE AI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 4 - Runtime and Performance Profiling
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh/2025sp/lab4/" hreflang="zh" class="md-select__link">
              繁體中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/NCKU-AISLAB/force-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aislab/force-ai
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab1/" class="md-tabs__link">
          
  
  
  Tutorial

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../developers/" class="md-tabs__link">
        
  
  
    
  
  Developer Guides

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FORCE AI" class="md-nav__button md-logo" aria-label="FORCE AI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    FORCE AI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NCKU-AISLAB/force-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aislab/force-ai
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 1 - AI Model Design and Quantization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 2 - Performance Modeling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 3 - Hardware Architecture Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Lab 4 - Runtime and Performance Profiling
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Lab 4 - Runtime and Performance Profiling
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-41-device-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 4.1 - Device Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 4.1 - Device Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-do-we-need-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Why Do We Need Driver ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communication-between-cpu-and-peripheral-device" class="md-nav__link">
    <span class="md-ellipsis">
      Communication between CPU and Peripheral Device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-hardware-co-design-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Software-Hardware Co-design Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-42-performance-profiling-and-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 4.2 - Performance Profiling and Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 4.2 - Performance Profiling and Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-we-need-cpu-performance-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      Why we need CPU performance profiling ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-measurement-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Measurement Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      CPU Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dla-info-record-for-performance-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      DLA info Record for Performance Profiling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice" class="md-nav__link">
    <span class="md-ellipsis">
      Practice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Directory Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-dla-driver" class="md-nav__link">
    <span class="md-ellipsis">
      1. DLA driver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-cpu-runtime-api" class="md-nav__link">
    <span class="md-ellipsis">
      2. CPU Runtime API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 5 - AI Compiler
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developer Guides
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-41-device-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 4.1 - Device Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 4.1 - Device Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-do-we-need-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Why Do We Need Driver ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communication-between-cpu-and-peripheral-device" class="md-nav__link">
    <span class="md-ellipsis">
      Communication between CPU and Peripheral Device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-hardware-co-design-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Software-Hardware Co-design Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-42-performance-profiling-and-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lab 4.2 - Performance Profiling and Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab 4.2 - Performance Profiling and Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-we-need-cpu-performance-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      Why we need CPU performance profiling ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-measurement-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Measurement Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      CPU Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dla-info-record-for-performance-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      DLA info Record for Performance Profiling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice" class="md-nav__link">
    <span class="md-ellipsis">
      Practice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Directory Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-dla-driver" class="md-nav__link">
    <span class="md-ellipsis">
      1. DLA driver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-cpu-runtime-api" class="md-nav__link">
    <span class="md-ellipsis">
      2. CPU Runtime API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lab-4-runtime-and-performance-profiling">Lab 4 - Runtime and Performance Profiling</h1>
<h2 id="overview">Overview</h2>
<p>In this lab, we will implement a software driver to enable integration and operation of the previously designed hardware accelerator with the host system. Through mechanisms such as memory-mapped I/O or interrupts, we establish control and data communication between the CPU and the accelerator. The <strong>driver acts as a critical interface layer between the runtime system and the hardware accelerator</strong>, exposing low-level register or memory access as high-level software APIs. The <strong>runtime</strong>, which orchestrates the overall inference flow, leverages the driver to configure the accelerator, transfer data, and retrieve results. This separation of concerns allows the runtime to focus on model-level control logic, while the driver handles hardware-specific interactions.
This architecture enables us to evaluate the performance gains provided by the accelerator during real model inference. Additionally, we investigate the feasibility and effectiveness of optimization techniques for accelerating inference in the absence of hardware acceleration. Through these experiments and analyses, we aim to gain a comprehensive understanding of how hardware acceleration and optimization affect model inference performance under different scenarios, thereby providing practical insights for future system design and deployment.</p>
<p><img alt="image" src="../../assets/images/HJjjWpqR1x.png" /></p>
<h2 id="lab-41-device-driver">Lab 4.1 - Device Driver</h2>
<p><strong>Driver</strong> is a special type of software responsible for <strong>enabling the operating system to control hardware devices</strong>. It acts like a <strong>translator or bridge</strong> between the operating system and the hardware. The operating system itself does not directly manipulate hardware; instead, it uses drivers to <strong>instruct the hardware what to do</strong>.</p>
<h3 id="why-do-we-need-driver">Why Do We Need Driver ?</h3>
<h4 id="the-os-doesnt-understand-hardware-languages">The OS Doesn’t Understand Hardware Languages</h4>
<p>Each hardware device (such as printers, keyboards, network cards) has its <strong>own specific control mechanisms</strong>. The operating system cannot directly handle these differences. Drivers are responsible for <strong>translating OS commands into signals that the hardware can understand</strong>, and then returning responses from the hardware back to the OS.</p>
<h4 id="supporting-various-hardware-with-one-os">Supporting Various Hardware with One OS</h4>
<p>With drivers, no matter which manufacturer produces the hardware, as long as a compatible driver exists, the OS can control the device. This means the OS <strong>does not need to be rewritten for each different hardware</strong>.</p>
<h4 id="software-perspective">Software Perspective</h4>
<ul>
<li>A driver is a piece of <strong>low-level system software</strong>, usually running within the <strong>kernel space</strong> of the OS.</li>
<li>It provides a <strong>standard interface (API)</strong> for applications or the OS to call (e.g., to read or send data).</li>
<li>It also <strong>handles hardware interrupts</strong>, such as notifying the OS when "data is ready" or "operation completed."</li>
</ul>
<h4 id="hardware-perspective">Hardware Perspective</h4>
<ul>
<li>The driver <strong>reads from and writes to control registers</strong> of the hardware (e.g., through memory-mapped I/O).</li>
<li>It <strong>controls hardware behavior</strong> based on configurations (e.g., starting data transfer, resetting the device).</li>
<li>It also <strong>facilitates data movement</strong>, such as transferring data from the hardware into main memory (RAM).</li>
</ul>
<h3 id="communication-between-cpu-and-peripheral-device">Communication between CPU and Peripheral Device</h3>
<p>In modern computer systems, the CPU needs to exchange data with various peripheral devices, such as keyboards, network interfaces, graphics cards, and storage devices. These devices are not directly hardwired to the CPU for control. Instead, they are accessed through well-designed interface mechanisms, including:
* Memory-Mapped I/O (MMIO)
* Port-Mapped I/O (also known as I/O-mapped I/O)
* Interrupt</p>
<h4 id="mmio-memory-mapped-io">MMIO (Memory-Mapped I/O)</h4>
<p>MMIO is a design method where hardware device registers are mapped into the system’s memory address space. We use this method to control our DLA.</p>
<ul>
<li>Device registers are accessed using normal memory instructions (<code>load</code>, <code>store</code>).</li>
<li>Example:
    <div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">  </span><span class="o">*</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="mh">0xFFFF0000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write MMIO device</span>
</span></code></pre></div>
    <div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="mh">0xFFFF0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// read MMIO device</span>
</span></code></pre></div></li>
</ul>
<h4 id="port-mapped-io-isolated-io">Port-Mapped I/O (Isolated I/O)</h4>
<p>Devices are controlled via a separate I/O address space using specific CPU instructions (e.g., <code>in</code>, <code>out</code> on x86).</p>
<ul>
<li>Registers are not part of memory space.</li>
<li>Smaller address space (e.g., 64KB).</li>
</ul>
<h4 id="interrupt">Interrupt</h4>
<p>Interrupts allow devices to asynchronously notify the CPU of events. The CPU pauses execution, runs an <strong>Interrupt Service Routine (ISR)</strong>, then resumes.
<strong>Benefits:</strong>
- Avoids polling
- Enables timely response to I/O events</p>
<p><strong>Typical Use Cases:</strong>
- Timer ticks
- I/O completion (e.g., DMA, keyboard)
- Network packet arrival</p>
<h3 id="software-hardware-co-design-framework">Software-Hardware Co-design Framework</h3>
<p><img alt="image" src="../../assets/images/BybkMpcRJx.png" /></p>
<p>In real embedded systems, software (runtime) typically interacts with hardware through <strong>Memory-Mapped I/O (MMIO)</strong> or <strong>device drivers</strong>, enabling indirect access to registers or peripherals. However, in this lab, we do not have access to actual hardware. Instead, we use <strong>Verilator</strong> to translate Verilog RTL into cycle-accurate C++ models, generating a <em>Verilated model</em> for simulation.</p>
<p>The issue arises because Verilated models expose only <strong>low-level signal interfaces</strong> (e.g., <code>.clk</code>, <code>.rst</code>, <code>.data_in</code>, <code>.data_out</code>), unlike real hardware that provides register-based MMIO access. As a result, in order to control the Verilated hardware, the runtime must directly manipulate the internal C++ objects generated by Verilator. This tight coupling requires the runtime to conform to the structure and naming conventions of the Verilator testbench, which is <strong>not modular</strong> and <strong>hinders portability</strong>.</p>
<p>To address this problem, we introduce the <strong>Hardware Abstraction Layer (HAL)</strong> in this lab.</p>
<h4 id="purpose-and-benefits-of-hal">Purpose and Benefits of HAL</h4>
<ul>
<li>
<p><strong>Hardware Interface Abstraction</strong>
  HAL wraps the Verilated model and exposes an interface that resembles real hardware, such as <code>read_reg(addr)</code> and <code>write_reg(addr, value)</code>. This allows the runtime to remain <strong>agnostic to whether it is interacting with an RTL simulation or actual FPGA hardware</strong>.</p>
</li>
<li>
<p><strong>Unified Runtime Codebase</strong>
  With HAL in place, a single runtime implementation can be reused across both simulation and real hardware environments <strong>without any modification</strong>.</p>
</li>
<li>
<p><strong>Modularity via Runtime Library</strong>
  On top of HAL, a <strong>Runtime Library</strong> can be built to provide high-level operations (e.g., launching computation, setting parameters, fetching results). This allows the main application to focus purely on control logic, improving <strong>software modularity</strong>, <strong>maintainability</strong>, and <strong>portability</strong>.</p>
</li>
</ul>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Can we record the hardware runtime information like cycles, memory access time?</p>
<p>Yes, we provide <strong>info counter</strong> in the HAL.</p>
</div>
<h4 id="hal-info-counter">HAL info counter</h4>
<p>The runtime_info structure is designed to record execution-related metrics during hardware simulation or emulation. It provides useful insights into the system's behavior, performance, and memory access patterns. Below is a detailed explanation of each field:</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">include/hal/hal.hpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-2-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-2-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-2-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-2-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-2-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-2-100">100</a></span>
<span class="normal"><a href="#__codelineno-2-101">101</a></span>
<span class="normal"><a href="#__codelineno-2-102">102</a></span>
<span class="normal"><a href="#__codelineno-2-103">103</a></span>
<span class="normal"><a href="#__codelineno-2-104">104</a></span>
<span class="normal"><a href="#__codelineno-2-105">105</a></span>
<span class="normal"><a href="#__codelineno-2-106">106</a></span>
<span class="normal"><a href="#__codelineno-2-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94"></a><span class="cm">/**</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95"></a><span class="cm"> * @struct runtime_info</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96"></a><span class="cm"> * @brief Stores runtime performance metrics for a hardware simulation or</span>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97"></a><span class="cm"> * execution.</span>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98"></a><span class="cm"> *</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99"></a><span class="cm"> * This structure holds information about execution cycles, elapsed time, and</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100"></a><span class="cm"> * memory operations during a hardware simulation or a specific computation.</span>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="cm"> */</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102"></a><span class="k">struct</span><span class="w"> </span><span class="nc">runtime_info</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">elapsed_cycle</span><span class="p">;</span><span class="w">  </span><span class="c1">///&lt; Number of cycles elapsed during execution.</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">elapsed_time</span><span class="p">;</span><span class="w">   </span><span class="c1">///&lt; Total elapsed time (e.g., in nanoseconds).</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">memory_read</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; Total number of memory read operations.</span>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">memory_write</span><span class="p">;</span><span class="w">   </span><span class="c1">///&lt; Total number of memory write operations.</span>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="p">};</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The HAL counters do not simulate software-level counters; instead, they function more like debug counters that are typically embedded in hardware during design for debugging and analysis purposes. However, in our hardware implementation, we did not allocate dedicated registers for such counters. Instead, we supplement these counters within the HAL, allowing the driver to access them during simulation or emulation.</p>
</div>
<div class="admonition question address mapping problem">
<p class="admonition-title">Question</p>
<p>Our simulated CPU uses 64-bit addresses, but our memory-mapped peripherals (MMIO) only occupy a small 32-bit region.</p>
<ul>
<li>
<p>How do we bridge the address space between the CPU and simulated devices?</p>
</li>
<li>
<p>Why can't we directly access <code>ARADDR_M</code> in a 64-bit simulation environment?</p>
</li>
</ul>
</div>
<h4 id="hal-simple-mmu-mapping-32-bit-axi-addresses-in-a-64-bit-simulation">HAL Simple MMU: Mapping 32-bit AXI Addresses in a 64-bit Simulation</h4>
<p>In our simulation environment, the host system uses a <strong>64-bit</strong> virtual memory space, while the AXI bus operates with <strong>32-bit</strong> addresses. This mismatch can cause address mapping issues, as AXI requests may not directly correspond to valid host memory addresses.</p>
<p>To resolve this, we implement a simple MMU mechanism within the HAL. By capturing the <strong>high 32 bits</strong> of the HAL instance’s address (<code>vm_addr_h</code>), we can reconstruct valid <strong>64-bit</strong> addresses by combining them with <strong>32-bit</strong> AXI addresses:</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="cm">/* HAL Constructor */</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="n">HardwareAbstractionLayer</span><span class="o">::</span><span class="n">HardwareAbstractionLayer</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">baseaddr</span><span class="p">,</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">                                                   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mmio_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">vm_addr_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff00000000</span><span class="p">);</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">baseaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseaddr</span><span class="p">;</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmio_size</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<!--digraph {
    rankdir="LR"
    node [shape=record];
    bits [label="{
        {...| ...} |
        {{program|heap \>\>}| mapping to AXI \(4GB memory space\) } |
        {...| ...}
    }"];
}-->

<p><img src="../../assets/svgs/lab4_graphviz_0.svg" alt="graphviz_0"></p>
<div class="admonition warning segmentation fault">
<p class="admonition-title">Warning</p>
<p>If the mapping address crosses the <strong>32-bit</strong> peripheral space boundary, invalid access may occur. This happens because the host's <strong>64-bit</strong> address space cannot safely simulate memory outside the defined <strong>32-bit</strong> region.</p>
<!--    digraph {
   rankdir="LR"
   node [shape=record];
   bits [label="{
       {...| ...} |
       {{program|heap \>\>}| mapping to AXI <span class="arithmatex">\(4GB memory space\)</span> } |
       {{\<\< heap|stack|...} | (Segmentation fault)}
   }"];
}-->
</div>
<p><img src="../../assets/svgs/lab4_graphviz_1.svg" alt="graphviz_1"></p>
<div class="language-text highlight"><pre><span></span><code>If need, the MMU eed to be optimized in the future,  but in this lab, 4GB address space is enough for simulations.
</code></pre></div>
<h4 id="support-mmio-write-in-hal-with-axi-interface">Support MMIO write in HAL with AXI interface</h4>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">HardwareAbstractionLayer::memory_set</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL] device is not init yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>When a write request is issued via HAL, the first step is to verify whether the provided address falls within the valid MMIO (Memory-Mapped I/O) region. This region starts at <code>baseaddr</code> and spans a range defined by <code>mmio_size</code>, meaning a valid address must lie within the interval <code>[baseaddr, baseaddr + mmio_size]</code>. If the address fails this check (i.e., it is out of bounds), HAL will immediately return false, indicating that the operation is invalid and halting any further processing.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL memory_set] (0x%08x) 0x%08x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="cp">#endif</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">baseaddr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">baseaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mmio_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">                </span><span class="s">&quot;[HAL ERROR] address 0x%08x is not in device MMIO range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">                </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="cp">#endif</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Following a successful address check, HAL proceeds with the AXI4 protocol, using three separate channels to complete a full write transaction. The first is the Address Write (AW) channel. HAL sets the target address into <code>AWADDR_S</code> and asserts <code>AWVALID_S</code> to signal that a valid address is being presented. The system then waits for the counterpart (typically an interconnect or slave device) to assert <code>AWREADY_S</code>, indicating readiness to accept the address. Once <code>AWREADY_S</code> is high, HAL advances one clock cycle and de-asserts <code>AWVALID_S</code>, completing the address phase.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="c1">// send write address</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWADDR_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWLEN_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">    </span><span class="c1">// unused</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWSIZE_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// unused</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWBURST_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// unused</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// valid</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="c1">// wait for ready (address)</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWREADY_S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>After sending the address, HAL transitions to the data write phase using the Write Data (W) channel. The data is placed in <code>WDATA_S</code>, and <code>WVALID_S</code> is asserted to indicate the data is valid. Similar to the address phase, HAL waits for WREADY_S to be asserted by the receiver, signaling that it is ready to accept the data. At that point, HAL advances one clock cycle and de-asserts <code>WVALID_S</code>, marking the completion of the data transmission.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">    </span><span class="c1">// send write data</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WDATA_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WSTRB_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// unused</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WLAST_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="c1">// single shot, always the last one</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// valid</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">    </span><span class="c1">// wait for ready (data)</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WREADY_S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>Once the data is successfully sent, the final step is to receive the write response through the B (Write Response) channel. HAL first asserts <code>BREADY_S</code> to indicate that it is ready to receive a response, then waits for <code>BVALID_S</code> to be asserted by the receiver. Once <code>BVALID_S</code> goes high, HAL reads the value of <code>BRESP_S</code> to determine whether the write was successful. If the response is <code>AXI_RESP_OKAY</code>, the operation is considered successful and HAL returns true; otherwise, it returns false.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">    </span><span class="c1">// wait for write response</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BREADY_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BVALID_S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BREADY_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BRESP_S</span><span class="p">;</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AXI_RESP_OKAY</span><span class="p">;</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="support-mmio-read-in-hal-with-axi-interface">Support MMIO read in HAL with AXI interface</h4>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">HardwareAbstractionLayer::memory_get</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL] device is not init yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>When a read request is issued through the HAL, the first step is to verify whether the target address falls within the valid MMIO (Memory-Mapped I/O) region. If the address is out of bounds, the HAL immediately returns false, indicating that the operation is invalid and that no further steps will be taken.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL memory_get] (0x%08x) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="cp">#endif</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">baseaddr</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">baseaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mmio_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">                </span><span class="s">&quot;[HAL ERROR] address 0x%08x is not in device MMIO range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">                </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="cp">#endif</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>If the address passes the check, the HAL proceeds to carry out the read transaction following the AXI4 protocol, which involves a three-phase operation. The first phase uses the AR (Address Read) channel. The HAL sets the target read address to <code>ARADDR_S</code> and asserts <code>ARVALID_S</code>, signaling that a valid read request is being issued. At this point, the system waits for the receiving end (such as an interconnect or slave device) to assert <code>ARREADY_S</code>, indicating readiness to accept the address. Once <code>ARREADY_S</code> is high, the HAL advances one clock cycle and de-asserts <code>ARVALID_S</code>, completing the address transmission.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="c1">// send read address</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARADDR_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARLEN_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">    </span><span class="c1">// unused</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARSIZE_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// unused</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARBURST_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// unused</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// valid</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">    </span><span class="c1">// wait for ready (address)</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARREADY_S</span><span class="p">);</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARVALID_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>After the address phase is completed, the HAL transitions to the data reception phase via the R (Read Data) channel. It first asserts <code>RREADY_S</code> to indicate that it is ready to receive data. When the slave asserts <code>RVALID_S</code>, signaling that valid data is available, the HAL immediately reads the value on <code>RDATA_S</code> and de-asserts <code>RREADY_S</code>, completing the data transfer.</p>
<p><div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">    </span><span class="c1">// wait for valid (data)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RREADY_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RVALID_S</span><span class="p">);</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RREADY_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
Finally, the HAL examines the contents of <code>RRESP_S</code>to determine the status of the read operation. If the response is <code>AXI_RESP_OKAY</code>, the read is considered successful, and the retrieved data is stored in the specified variable. The function then returns true. Otherwise, if the response indicates an error, the HAL returns false, signaling that the read operation failed.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">    </span><span class="c1">// get read data</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RDATA_S</span><span class="p">;</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RRESP_S</span><span class="p">;</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AXI_RESP_OKAY</span><span class="p">;</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>We’ve now covered the HAL info counter and the simple MMU. With this knowledge, we’re ready to integrate them into the DMA handler.</p>
<h4 id="support-dma-read-in-hal-with-axi-interface">Support DMA read in HAL with AXI interface</h4>
<p>In the DMA read handling routine provided by our HAL, the process begins by retrieving the read address and burst length from the master interface. Specifically, the address is obtained from <code>ARADDR_M</code> and the burst length is retrieved from <code>ARLEN_M</code>, which determines the number of data beats to be transferred in this burst operation (for a total of <code>len + 1</code> beats, as the AXI burst length is zero-based).</p>
<p>To initiate the transaction, the HAL asserts <code>ARREADY_M</code> to complete the address handshake on the AR channel. After simulating a clock cycle to reflect the timing behavior of the interface, <code>ARREADY_M</code> is de-asserted, signaling that the address phase is complete.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">HardwareAbstractionLayer::handle_dma_read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="c1">// get read address</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">vm_addr_h</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARADDR_M</span><span class="p">);</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARLEN_M</span><span class="p">;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ARREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL handle_dma_read] addr = %p, len = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">            </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="cp">#endif</span>
</span></code></pre></div></td></tr></table></div>
<p>Once the read address is acknowledged, the HAL proceeds to send data through the R channel in a burst manner. For each data beat, the corresponding memory content is fetched from the emulated memory <code>(*(addr + i))</code> and sent through <code>RDATA_M</code>. The data response is always set to <code>AXI_RESP_OKAY</code>, and <code>RID_M</code> is set to 0 by default. Before sending each beat, the HAL simulates a memory access delay by incrementing <code>info.elapsed_cycle</code> and <code>info.elapsed_time</code> accordingly.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="c1">// send read data (increase mode, burst_size 32bits)</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// default</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RRESP_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AXI_RESP_OKAY</span><span class="p">;</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RDATA_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">           </span><span class="c1">// send read data</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">MEM_ACCESS_CYCLE</span><span class="p">;</span><span class="w">  </span><span class="c1">// simulate memory access delay</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">MEM_ACCESS_CYCLE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CYCLE_TIME</span><span class="p">;</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL handle_dma_read] addr = %p, data = %08x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">                </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="cp">#endif</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RLAST_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w">  </span><span class="c1">// the last one</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RVALID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>During the burst, <code>RVALID_M</code> is asserted to indicate that data is valid, and the system waits until the DMA master sets <code>RREADY_M</code>, signaling it is ready to accept the data. Only then is the clock advanced and the next beat prepared. On the final beat of the burst, <code>RLAST_M</code> is asserted to indicate the end of the transfer.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">        </span><span class="c1">// wait DMA ready for next data</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RREADY_M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="w">            </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RVALID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>At the end of the transaction, the HAL updates the internal counter info.memory_read to reflect the total number of bytes read. This is computed as <code>(len + 1) * sizeof(uint32_t)</code>, and is used for performance monitoring and profiling purposes, such as bandwidth analysis or simulation statistics.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">    </span><span class="c1">// count memory access</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="n">memory_read</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="support-dma-write-in-hal-with-axi-interface">Support DMA write in HAL with AXI interface</h4>
<p>In the DMA write handling routine provided by our HAL, the process begins by retrieving the write address and burst length from the master interface. Specifically, the address is obtained from <code>AWADDR_M</code> and the burst length is retrieved from <code>AWLEN_M</code>, which determines the number of data beats to be transferred in this burst operation (for a total of <code>len + 1</code> beats, as the AXI burst length is zero-based).</p>
<p>To initiate the transaction, the HAL asserts <code>AWREADY_M</code> to complete the address handshake on the AW channel. After simulating a clock cycle to reflect the timing behavior of the interface, <code>AWREADY_M</code> is de-asserted, signaling that the address phase is complete.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">HardwareAbstractionLayer::handle_dma_write</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="c1">// get address</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">vm_addr_h</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWADDR_M</span><span class="p">);</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWLEN_M</span><span class="p">;</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">AWREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL handle_dma_write] addr = %p, len = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">            </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="cp">#endif</span>
</span></code></pre></div></td></tr></table></div>
<p>Once the write address is acknowledged, the HAL proceeds to receive data through the W channel in a burst manner. For each data beat, the corresponding data is obtained from <code>WDATA_M</code> and written into the emulated memory <code>(*(addr + i))</code>. Before processing each beat, the HAL simulates a memory access delay by incrementing <code>info.elapsed_cycle</code> and <code>info.elapsed_time</code> accordingly.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="c1">// recv write data (increase mode, burst_size 32bits)</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">RID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// default</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WDATA_M</span><span class="p">;</span><span class="w">  </span><span class="c1">// recv write data</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">MEM_ACCESS_CYCLE</span><span class="p">;</span><span class="w">  </span><span class="c1">// simulate memory access delay</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">MEM_ACCESS_CYCLE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CYCLE_TIME</span><span class="p">;</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="cp">#ifdef DEBUG</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[HAL handle_dma_write] addr = %p, data = %08x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">                </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="cp">#endif</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>During the burst, <code>WREADY_M</code> is asserted to indicate that the HAL is ready to accept data. The system then waits until the DMA master sets <code>WVALID_M</code>, signaling the data is valid and ready to be written. Once valid data is detected, the clock is advanced and <code>WREADY_M</code> is de-asserted to complete the handshake for that beat.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29"></a><span class="w">        </span><span class="c1">// wait DMA valid for next data</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WVALID_M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31"></a><span class="w">            </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34"></a><span class="w">        </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">WREADY_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>At the end of the data transfer, the HAL sends a write response by asserting <code>BVALID_M</code> and setting <code>BRESP_M</code> to <code>AXI_RESP_OKAY</code>, indicating a successful write operation. <code>BID_M</code> is set to 0 by default. The system then waits until the DMA master asserts <code>BREADY_M</code> to acknowledge the response, after which the response phase is completed and <code>BVALID_M</code> is de-asserted.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span>
<span class="normal"><a href="#__codelineno-21-44">44</a></span>
<span class="normal"><a href="#__codelineno-21-45">45</a></span>
<span class="normal"><a href="#__codelineno-21-46">46</a></span>
<span class="normal"><a href="#__codelineno-21-47">47</a></span>
<span class="normal"><a href="#__codelineno-21-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38"></a><span class="w">    </span><span class="c1">// recv write response</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BRESP_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AXI_RESP_OKAY</span><span class="p">;</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BVALID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BREADY_M</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44"></a><span class="w">        </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46"></a><span class="w">    </span><span class="n">clock_step</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ACLK</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">BVALID_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48"></a><span class="w">    </span><span class="n">device</span><span class="o">-&gt;</span><span class="n">eval</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>Finally, the HAL updates the internal counter <code>info.memory_write</code> to reflect the total number of bytes written. This is computed as <code>(len + 1) * sizeof(uint32_t)</code>, and is used for performance monitoring and profiling purposes, such as bandwidth analysis or simulation statistics.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/hal/hal.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-49">49</a></span>
<span class="normal"><a href="#__codelineno-22-50">50</a></span>
<span class="normal"><a href="#__codelineno-22-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="w">    </span><span class="c1">// count memory access</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50"></a><span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="n">memory_write</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>The above describes the basic design concept and implementation of the HAL. For more detailed design information and parameters, you can refer to and explore the files located at <code>include/hal/hal.hpp</code> and <code>/src/hal/hal.cpp</code>.</p>
<h2 id="lab-42-performance-profiling-and-optimization">Lab 4.2 - Performance Profiling and Optimization</h2>
<h3 id="why-we-need-cpu-performance-profiling">Why we need CPU performance profiling ?</h3>
<p>In many embedded systems, edge devices, or environments lacking dedicated accelerators such as GPUs or NPUs, developers are often faced with the challenge of running AI models using only CPUs. Given the computationally intensive nature and frequent memory access patterns of AI models, performance can degrade significantly without proper analysis and optimization. Therefore, uncovering potential performance bottlenecks and applying compiler-level optimizations are crucial steps to ensure efficient AI inference on CPU-only platforms. This lecture introduces the use of performance analysis tools such as Valgrind and Cachegrind, along with common CPU-level optimization techniques, to help developers effectively deploy AI applications even in resource-constrained environments without hardware accelerators.</p>
<h3 id="performance-measurement-tool">Performance Measurement Tool</h3>
<h4 id="valgrind">Valgrind</h4>
<p>Valgrind is an open-source debugging and performance analysis tool for Linux, licensed under the GPL. Its suite of tools enables automated detection of memory management and threading issues, significantly reducing the time spent on debugging and enhancing program stability. Additionally, Valgrind provides in-depth profiling capabilities to optimize application performance.</p>
<h4 id="cachegrind">Cachegrind</h4>
<p><a href="https://valgrind.org/info/tools.html#cachegrind">Cachegrind</a> is a cache profiling tool that simulates the behavior of the I1 (instruction cache), D1 (data cache), and L2 caches in a CPU, providing precise identification of cache misses in code. It records the number of cache misses, memory accesses, and executed instructions at the source code level, offering detailed analysis at the function, module, and program-wide levels. Supporting programs written in any language, Cachegrind provides comprehensive profiling insights, though it operates at a runtime overhead of approximately 20 to 100 times slower than native execution.</p>
<h4 id="cachegrind-usage-guide">Cachegrind Usage Guide</h4>
<ol>
<li>start profiling a program using Cachegrind, run:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>valgrind --tool=cachegrind ./your_program
</span></code></pre></div>
<ol>
<li>The output file cachegrind.out.\&lt;pid&gt; contains detailed cache statistics. To generate a human-readable report, use:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>cg_annotate cachegrind.out.*
</span></code></pre></div>
<h4 id="advanced-configuration-customizing-cache-parameters">Advanced Configuration - Customizing Cache Parameters</h4>
<p>To simulate different CPU cache configurations, use <code>--I1</code>, <code>--D1</code>, and <code>--L2</code> options:
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>valgrind --tool=cachegrind --I1=&lt;size&gt;,&lt;assoc&gt;,&lt;line_size&gt; --D1=&lt;size&gt;,&lt;assoc&gt;,&lt;line_size&gt; --L2=&lt;size&gt;,&lt;assoc&gt;,&lt;line_size&gt; ./your_prog
</span></code></pre></div></p>
<h3 id="cpu-optimization">CPU Optimization</h3>
<h4 id="compiler-optimization-levels-gcc-clang-examples">Compiler Optimization Levels (GCC / Clang Examples)</h4>
<table>
<thead>
<tr>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-O0</code></td>
<td>No optimization. Suitable for debugging; preserves source code structure.</td>
</tr>
<tr>
<td><code>-O1</code></td>
<td>Enables basic optimizations. Safe and stable.</td>
</tr>
<tr>
<td><code>-O2</code></td>
<td>Moderate optimizations. Suitable for general use cases.</td>
</tr>
<tr>
<td><code>-O3</code></td>
<td>Aggressive optimizations including loop unrolling and vectorization.</td>
</tr>
</tbody>
</table>
<h4 id="common-optimization-techniques">Common Optimization Techniques</h4>
<table>
<thead>
<tr>
<th>Technique</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Loop Unrolling</strong></td>
<td>Expands loop bodies to reduce control overhead and improve instruction-level parallelism.</td>
</tr>
<tr>
<td><strong>SIMD Vectorization</strong></td>
<td>Uses SIMD instructions to process multiple data elements in parallel.</td>
</tr>
<tr>
<td><strong>Common Subexpression Elimination</strong></td>
<td>Eliminates redundant computations by reusing previously computed expressions.</td>
</tr>
<tr>
<td><strong>Constant Folding / Propagation</strong></td>
<td>Computes constant expressions at compile time and substitutes their values.</td>
</tr>
<tr>
<td><strong>Loop-Invariant Code Motion</strong></td>
<td>Moves calculations that do not change within a loop to outside the loop.</td>
</tr>
<tr>
<td><strong>Memory Allocation &amp; Alignment</strong></td>
<td>Using <code>malloc</code> can improve performance by ensuring better cache locality and memory alignment, especially for large or frequently accessed data.</td>
</tr>
</tbody>
</table>
<h5 id="examples"><strong>Examples</strong></h5>
<p><strong>Loop Unrolling</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Before</label><label for="__tabbed_1_2">After</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>This loop adds one element per iteration and includes overhead from loop control (increment, comparison).</p>
</div>
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></code></pre></div>
<p>By unrolling the loop, we reduce control instructions and increase instruction-level parallelism (ILP), improving CPU pipeline efficiency.</p>
</div>
</div>
</div>
<p><strong>SIMD Vectorization</strong></p>
<p>Compiler optimize <code>-O3</code>， the compiler automatically convert this loop into SIMD instructions.
Or</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kr">__m128</span><span class="w"> </span><span class="n">vb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm_loadu_ps</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="c1">// load 4 float number</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kr">__m128</span><span class="w"> </span><span class="n">vc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm_loadu_ps</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="kr">__m128</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm_add_ps</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="w"> </span><span class="n">vc</span><span class="p">);</span><span class="w"> </span><span class="c1">// SIMD ADD</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="n">_mm_storeu_ps</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">);</span><span class="w">          </span><span class="c1">// store</span>
</span></code></pre></div>
<p>SIMD processes multiple elements in parallel, reducing the number of arithmetic and memory access instructions.</p>
<p><strong>Common Subexpression Elimination</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Before</label><label for="__tabbed_2_2">After</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">         </span><span class="c1">// Constant Folding</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">         </span><span class="c1">// Constant Propagation</span>
</span></code></pre></div>
<p>The expression <code>(x + 2)</code> is calculated twice — a redundant computation.</p>
</div>
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span></code></pre></div>
<p>The optimized version computes the common expression only once, reducing ALU usage.</p>
</div>
</div>
</div>
<p><strong>Constant Folding / Propagation</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Before</label><label for="__tabbed_3_2">After</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span></code></pre></div>
<p>The compiler can compute these values at compile time and replace them with constants.</p>
</div>
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
</span></code></pre></div>
<p>Reduces runtime computation and generates simpler machine code.</p>
</div>
</div>
</div>
<p><strong>Loop-Invariant Code Motion</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Before</label><label for="__tabbed_4_2">After</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>The expression <code>a * b</code> is invariant across iterations and gets recalculated unnecessarily.</p>
</div>
<div class="tabbed-block">
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>Moves constant computation outside the loop, reducing the number of multiplications.</p>
</div>
</div>
</div>
<p><strong>Memory Allocation &amp; Alignment</strong></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></code></pre></div>
<p>Default <code>malloc</code> alignment may be suboptimal for cache usage and SIMD.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">posix_memalign</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></code></pre></div>
<p>Aligning to 64 bytes improves cache line utilization and enables efficient SIMD access — especially beneficial for large data structures like tensors and matrices.Most modern CPUs use a 64-byte cache line size, so aligning memory to 64-byte boundaries ensures that data fits neatly within a single cache line, avoiding splits across multiple lines and reducing cache misses.</p>
<h4 id="notes-and-caveats">Notes and Caveats</h4>
<ul>
<li>Optimizations may make debugging more difficult (e.g., variables may be inlined or eliminated).</li>
<li>Programs with <strong>undefined behavior</strong> may yield unexpected results under optimization.</li>
</ul>
<h3 id="dla-info-record-for-performance-profiling">DLA info Record for Performance Profiling</h3>
<p>From the above introduction to the HAL, we can see that the info struct contains four counters. We have therefore exposed functionality to read and reset these counters at the DLA driver level.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/hardware_dla.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25"></a><span class="k">struct</span><span class="w"> </span><span class="nc">runtime_info</span><span class="w"> </span><span class="n">get_runtime_info</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">hal</span><span class="p">.</span><span class="n">get_runtime_info</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26"></a><span class="kt">void</span><span class="w"> </span><span class="n">reset_runtime_info</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hal</span><span class="p">.</span><span class="n">reset_runtime_info</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/runtime_dla.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dla_reset_runtime_info</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">reset_runtime_info</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Additionally, we provide an API that exports DLA computation information along with the counters recorded by the HAL into a CSV file, facilitating further analysis.</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/runtime_dla.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-34">34</a></span>
<span class="normal"><a href="#__codelineno-39-35">35</a></span>
<span class="normal"><a href="#__codelineno-39-36">36</a></span>
<span class="normal"><a href="#__codelineno-39-37">37</a></span>
<span class="normal"><a href="#__codelineno-39-38">38</a></span>
<span class="normal"><a href="#__codelineno-39-39">39</a></span>
<span class="normal"><a href="#__codelineno-39-40">40</a></span>
<span class="normal"><a href="#__codelineno-39-41">41</a></span>
<span class="normal"><a href="#__codelineno-39-42">42</a></span>
<span class="normal"><a href="#__codelineno-39-43">43</a></span>
<span class="normal"><a href="#__codelineno-39-44">44</a></span>
<span class="normal"><a href="#__codelineno-39-45">45</a></span>
<span class="normal"><a href="#__codelineno-39-46">46</a></span>
<span class="normal"><a href="#__codelineno-39-47">47</a></span>
<span class="normal"><a href="#__codelineno-39-48">48</a></span>
<span class="normal"><a href="#__codelineno-39-49">49</a></span>
<span class="normal"><a href="#__codelineno-39-50">50</a></span>
<span class="normal"><a href="#__codelineno-39-51">51</a></span>
<span class="normal"><a href="#__codelineno-39-52">52</a></span>
<span class="normal"><a href="#__codelineno-39-53">53</a></span>
<span class="normal"><a href="#__codelineno-39-54">54</a></span>
<span class="normal"><a href="#__codelineno-39-55">55</a></span>
<span class="normal"><a href="#__codelineno-39-56">56</a></span>
<span class="normal"><a href="#__codelineno-39-57">57</a></span>
<span class="normal"><a href="#__codelineno-39-58">58</a></span>
<span class="normal"><a href="#__codelineno-39-59">59</a></span>
<span class="normal"><a href="#__codelineno-39-60">60</a></span>
<span class="normal"><a href="#__codelineno-39-61">61</a></span>
<span class="normal"><a href="#__codelineno-39-62">62</a></span>
<span class="normal"><a href="#__codelineno-39-63">63</a></span>
<span class="normal"><a href="#__codelineno-39-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34"></a><span class="kt">void</span><span class="w"> </span><span class="nf">create_dla_info_to_csv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Creating dla info file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36"></a><span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span>
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Create DLA info file failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-41"><a id="__codelineno-39-41" name="__codelineno-39-41"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span>
</span><span id="__span-39-42"><a id="__codelineno-39-42" name="__codelineno-39-42"></a><span class="w">            </span><span class="s">&quot;Operation,Cycles,Time(ns),Memory read,Memory &quot;</span>
</span><span id="__span-39-43"><a id="__codelineno-39-43" name="__codelineno-39-43"></a><span class="w">            </span><span class="s">&quot;write,m,e,p,q,r,t,PAD,U,R,S,C,M,W,H</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-39-44"><a id="__codelineno-39-44" name="__codelineno-39-44"></a><span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span id="__span-39-45"><a id="__codelineno-39-45" name="__codelineno-39-45"></a><span class="p">}</span>
</span><span id="__span-39-46"><a id="__codelineno-39-46" name="__codelineno-39-46"></a>
</span><span id="__span-39-47"><a id="__codelineno-39-47" name="__codelineno-39-47"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_dla_info_to_csv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">operation_name</span><span class="p">,</span>
</span><span id="__span-39-48"><a id="__codelineno-39-48" name="__codelineno-39-48"></a><span class="w">                          </span><span class="c1">// mapping parameter</span>
</span><span id="__span-39-49"><a id="__codelineno-39-49" name="__codelineno-39-49"></a><span class="w">                          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">q</span><span class="p">,</span>
</span><span id="__span-39-50"><a id="__codelineno-39-50" name="__codelineno-39-50"></a><span class="w">                          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
</span><span id="__span-39-51"><a id="__codelineno-39-51" name="__codelineno-39-51"></a><span class="w">                          </span><span class="c1">// shape parameter</span>
</span><span id="__span-39-52"><a id="__codelineno-39-52" name="__codelineno-39-52"></a><span class="w">                          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">PAD</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">S</span><span class="p">,</span>
</span><span id="__span-39-53"><a id="__codelineno-39-53" name="__codelineno-39-53"></a><span class="w">                          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-54"><a id="__codelineno-39-54" name="__codelineno-39-54"></a><span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">);</span>
</span><span id="__span-39-55"><a id="__codelineno-39-55" name="__codelineno-39-55"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">runtime_info</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_runtime_info</span><span class="p">();</span>
</span><span id="__span-39-56"><a id="__codelineno-39-56" name="__codelineno-39-56"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">operation_name</span><span class="p">);</span><span class="w">        </span><span class="c1">// Operation</span>
</span><span id="__span-39-57"><a id="__codelineno-39-57" name="__codelineno-39-57"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%10d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_cycle</span><span class="p">);</span><span class="w">  </span><span class="c1">// Cycles</span>
</span><span id="__span-39-58"><a id="__codelineno-39-58" name="__codelineno-39-58"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%10d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">elapsed_time</span><span class="p">);</span><span class="w">   </span><span class="c1">// Time (ns)</span>
</span><span id="__span-39-59"><a id="__codelineno-39-59" name="__codelineno-39-59"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%10d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">memory_read</span><span class="p">);</span><span class="w">    </span><span class="c1">// Memory read</span>
</span><span id="__span-39-60"><a id="__codelineno-39-60" name="__codelineno-39-60"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%10d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">memory_write</span><span class="p">);</span><span class="w">   </span><span class="c1">// Memory write</span>
</span><span id="__span-39-61"><a id="__codelineno-39-61" name="__codelineno-39-61"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d,%d,%d,%d,%d,%d,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
</span><span id="__span-39-62"><a id="__codelineno-39-62" name="__codelineno-39-62"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d,%d,%d,%d,%d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">PAD</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">);</span>
</span><span id="__span-39-63"><a id="__codelineno-39-63" name="__codelineno-39-63"></a><span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span id="__span-39-64"><a id="__codelineno-39-64" name="__codelineno-39-64"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If the simulation program is compiled with the DLA_INFO macro defined, this profiling feature will be enabled.</p>
<p><div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/runtime_dla.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dla_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="cp">#ifdef DLA_INFO</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DLA runtime info logging enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19"></a><span class="w">    </span><span class="n">dla_reset_runtime_info</span><span class="p">();</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w">    </span><span class="n">create_dla_info_to_csv</span><span class="p">(</span><span class="n">DLA_INFO_CSV</span><span class="p">);</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="cp">#endif</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">    </span><span class="n">hal_init</span><span class="p">();</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
The compilation usage will be mentioned in the homework section.</p>
</div>
<h2 id="practice">Practice</h2>
<p>In this lab, you learned about the HAL and basic concepts about device driver. Now it is your turn to implement the driver to support some operations of the DLA and the CPU.</p>
<p>In addition, you will implement several APIs to support operations commonly-used in CNNs such as convolution, maxpooling, relu, matmul, etc.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ol>
<li>Download the sample code and report template from Moodle and then decompress it.
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>unzip<span class="w"> </span>aoc2025-lab4.zip
</span></code></pre></div></li>
<li>Check Verilator version in this lab
    We are using Verilator 5.030. You can run the following command to verify it:
    <div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>verilator --version
</span></code></pre></div>
    It will show that.
    <div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>verilator 5.030
</span></code></pre></div></li>
</ol>
<h3 id="directory-structure">Directory Structure</h3>
<p>After unzipped the file downloaded from Moodle, the directory structure will look like below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>StudentID_lab4
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>├── hardware (DLA IP from verilator)
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>│   ..........
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>│
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>├── include
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>│   ├── eyeriss
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>│   │   └── runtime.h
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>│   └── hal
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>│       ├── axi.hpp
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>│       └── hal.hpp
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>├── src
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>│   ├── eyeriss
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>│   │   ├── cpu
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>│   │   │   ├── improve
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>│   │   │   │   ├── hardware_cpu.c
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>│   │   │   │   ├── hardware_cpu.h
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>│   │   │   │   └── runtime_cpu.c
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>│   │   │   └── original
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>│   │   │       ├── hardware_cpu.c
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>│   │   │       ├── hardware_cpu.h
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>│   │   │       └── runtime_cpu.c
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>│   │   └── dla
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>│   │       ├── hardware_dla.cpp
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>│   │       ├── hardware_dla.h
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>│   │       └── runtime_dla.cpp
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>│   └── hal
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>│       └── hal.cpp
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>├── test
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>│    ├── cpu
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>│    │   ├── data.h
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>│    │   ├── main.cpp
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>│    │   └── Makefile
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>│    └── dla
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>│        ├── dla0
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>│        │   ├── data.h
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>│        │   ├── main.cpp
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>│        │   └── Makefile
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>│        ├── dla1
</span><span id="__span-44-39"><a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>│        │   ├── data.h
</span><span id="__span-44-40"><a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a>│        │   ├── main.cpp
</span><span id="__span-44-41"><a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>│        │   └── Makefile
</span><span id="__span-44-42"><a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a>│        ├── dla2
</span><span id="__span-44-43"><a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a>│        │   ├── data.h
</span><span id="__span-44-44"><a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a>│        │   ├── main.cpp
</span><span id="__span-44-45"><a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a>│        │   └── Makefile
</span><span id="__span-44-46"><a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a>│        ├── dla3
</span><span id="__span-44-47"><a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a>│        │   ├── main.cpp
</span><span id="__span-44-48"><a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a>│        │   └── Makefile
</span><span id="__span-44-49"><a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a>│        ├── makefile
</span><span id="__span-44-50"><a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a>│        └── Makefile
</span><span id="__span-44-51"><a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a>└── report.md
</span></code></pre></div>
<h3 id="1-dla-driver">1. DLA driver</h3>
<p>In Lab 3, you have already implemented the complete PE-array architecture and the PPU. Now, in this lab, the TAs will provide you with the entire accelerator IP. The complete architecture is shown in the diagram below, which includes sub-modules such as the controller, global buffer, DMA, and MMIO AXI interface. We have already used Verilator to convert it into a C++ library and connected it to the HAL. Your task for this lab is to implement the DLA driver on top of the HAL.</p>
<p><img alt="image" src="../../assets/images/HJ1bz69C1x.png" /></p>
<h4 id="mmio-register-configuration">MMIO register configuration</h4>
<p>The following is the MMIO configuration of the accelerator when mapped into memory space. It includes the memory information it needs to operate on, as well as the computation parameters. It is important to note that the enable register should only be set after all parameters have been properly configured. This ensures the accelerator correctly reads the parameters before starting. Therefore, when implementing the driver, you must take the order of register writes into account.</p>
<p>We mount the DLA on <strong>0x10040000</strong> ~ <strong>0x10041000</strong> of the system address space (in <code>src/eyeriss/dla/hardware_dla.h</code>)</p>
<div class="language-c highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/hardware_dla.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="cm">/* ========================= DLA Register Base Address &amp; Size ========================= */</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="cp">#define DLA_MMIO_BASE_ADDR  0x10040000   </span><span class="c1">///&lt; Base address of the DLA MMIO registers.</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="cp">#define DLA_MMIO_SIZE 0x1000  </span><span class="c1">///&lt; Size of the DLA register memory map.</span>
</span></code></pre></div></td></tr></table></div>
<p>The following MMIO registers are all 32-bit (4 bytes) wide. Each address represents the starting location of the corresponding data.</p>
<table>
<thead>
<tr>
<th>Address Offset</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x0</code></td>
<td><code>enable</code></td>
<td>DLA enable with operation config</td>
</tr>
<tr>
<td><code>0x4</code></td>
<td><code>mapping_param</code></td>
<td>Mapping Parameter</td>
</tr>
<tr>
<td><code>0x8</code></td>
<td><code>shape_param1</code></td>
<td>Shape Parameter</td>
</tr>
<tr>
<td><code>0xc</code></td>
<td><code>shape_param2</code></td>
<td>Shape Parameter 2</td>
</tr>
<tr>
<td><code>0x10</code></td>
<td><code>ifmap_addr</code></td>
<td>Input feature map address (Starting address in DRAM)</td>
</tr>
<tr>
<td><code>0x14</code></td>
<td><code>filter_addr</code></td>
<td>Filter address (Starting address in DRAM)</td>
</tr>
<tr>
<td><code>0x18</code></td>
<td><code>bias_addr</code></td>
<td>Bias address (Starting address in DRAM)</td>
</tr>
<tr>
<td><code>0x1c</code></td>
<td><code>ofmap_addr</code></td>
<td>Output feature map address (Starting address in DRAM)</td>
</tr>
<tr>
<td><code>0x20</code></td>
<td><code>GLB_filter_addr</code></td>
<td>Global buffer filter address (Starting address in GLB)</td>
</tr>
<tr>
<td><code>0x24</code></td>
<td><code>GLB_opsum_addr</code></td>
<td>Global buffer output sum address</td>
</tr>
<tr>
<td><code>0x28</code></td>
<td><code>GLB_bias_addr</code></td>
<td>Global buffer bias address</td>
</tr>
<tr>
<td><code>0x2c</code></td>
<td><code>ifmap_len</code></td>
<td>Input feature map length</td>
</tr>
<tr>
<td><code>0x30</code></td>
<td><code>ofmap_len</code></td>
<td>Output feature map length</td>
</tr>
</tbody>
</table>
<p>You can see the C MACRO define in <code>src/eyeriss/dla/hardware_dla.h</code></p>
<div class="language-c highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/hardware_dla.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span>
<span class="normal"><a href="#__codelineno-46-29">29</a></span>
<span class="normal"><a href="#__codelineno-46-30">30</a></span>
<span class="normal"><a href="#__codelineno-46-31">31</a></span>
<span class="normal"><a href="#__codelineno-46-32">32</a></span>
<span class="normal"><a href="#__codelineno-46-33">33</a></span>
<span class="normal"><a href="#__codelineno-46-34">34</a></span>
<span class="normal"><a href="#__codelineno-46-35">35</a></span>
<span class="normal"><a href="#__codelineno-46-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="cm">/* ========================= DLA Register Offsets ========================= */</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="cp">#define DLA_ENABLE_OFFSET 0x0  </span><span class="c1">///&lt; Offset for enabling/disabling the DLA.</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="cp">#define DLA_MAPPING_PARAM_OFFSET   0x4  </span><span class="c1">///&lt; Offset for setting mapping parameters.</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="cp">#define DLA_SHAPE_PARAM1_OFFSET    0x8  </span><span class="c1">///&lt; Offset for shape parameters (filter, channel).</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="cp">#define DLA_SHAPE_PARAM2_OFFSET    0xc  </span><span class="c1">///&lt; Offset for shape parameters (input size, padding).</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="cp">#define DLA_IFMAP_ADDR_OFFSET      0x10   </span><span class="c1">///&lt; Offset for input feature map address.</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="cp">#define DLA_FILTER_ADDR_OFFSET     0x14  </span><span class="c1">///&lt; Offset for filter weights address.</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28"></a><span class="cp">#define DLA_BIAS_ADDR_OFFSET       0x18    </span><span class="c1">///&lt; Offset for bias values address.</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29"></a><span class="cp">#define DLA_OPSUM_ADDR_OFFSET      0x1c   </span><span class="c1">///&lt; Offset for output sum buffer address.</span>
</span><span id="__span-46-30"><a id="__codelineno-46-30" name="__codelineno-46-30"></a><span class="cp">#define DLA_GLB_FILTER_ADDR_OFFSET 0x20  </span><span class="c1">///&lt; Offset for global filter weights address.</span>
</span><span id="__span-46-31"><a id="__codelineno-46-31" name="__codelineno-46-31"></a><span class="cp">#define DLA_GLB_OFMAP_ADDR_OFFSET  0x24  </span><span class="c1">///&lt; Offset for global output feature map address.</span>
</span><span id="__span-46-32"><a id="__codelineno-46-32" name="__codelineno-46-32"></a><span class="cp">#define DLA_GLB_BIAS_ADDR_OFFSET   0x28                           </span><span class="c1">///&lt; Offset for global bias values address.</span>
</span><span id="__span-46-33"><a id="__codelineno-46-33" name="__codelineno-46-33"></a><span class="cp">#define DLA_IFMAP_LEN_OFFSET       0x2c  </span><span class="c1">///&lt; Offset for input activation length.</span>
</span><span id="__span-46-34"><a id="__codelineno-46-34" name="__codelineno-46-34"></a><span class="cp">#define DLA_OFMAP_LEN_OFFSET       0x30  </span><span class="c1">///&lt; Offset for output activation length.</span>
</span><span id="__span-46-35"><a id="__codelineno-46-35" name="__codelineno-46-35"></a>
</span><span id="__span-46-36"><a id="__codelineno-46-36" name="__codelineno-46-36"></a><span class="cp">#define DLA_UNDEFINED  </span><span class="c1">///&lt; Placeholder for undefined registers.</span>
</span></code></pre></div></td></tr></table></div>
<p>The details of the bitwise configuration for the first four MMIO registers are as follows. Then, you have to implement them in <code>src/eyeriss/dla/hardware_dla.c</code></p>
<h5 id="1-dla-enable-with-operation-config">1. DLA enable with operation config</h5>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>enable</code> register should be the last one when setting MMIO registers.</p>
</div>
<!--digraph {
    rankdir="LR"
    node [shape=record];
    bits [label="{
        {{31 ... 10}|reserved} |
        {{9|8|7|6|5|4}|scale} |
        {3|operation} |
        {2|relu} |
        {1|maxpool} |
        {0|en}
    }"];
}-->

<p><img src="../../assets/svgs/lab4_graphviz_2.svg" alt="graphviz_2"></p>
<ul>
<li><strong>operation</strong><ul>
<li><code>0</code> for CONV.</li>
<li><code>1</code> (Reserved, this operation did not implemented in the ASIC, you can extend the operation like FCN in the future).</li>
</ul>
</li>
<li><strong>relu, maxpool, en</strong><ul>
<li><code>0</code> for disable.</li>
<li><code>1</code> for enable.</li>
</ul>
</li>
<li><strong>scale</strong><ul>
<li>Quantize and requantization scaling factor represented as a power of two.</li>
</ul>
</li>
</ul>
<h5 id="2-mapping-parameter-mapping_param-please-refer-to-the-paper-for-the-definition">2. Mapping Parameter (mapping_param) - Please refer to the paper for the definition.</h5>
<!--digraph {
    rankdir="LR"
    node [shape=record];
    bits [label="{
        {{31 ... 26}|reserved} |
        {{25|24|23|22|21|20|19|18|17|16}|m} |
        {{15|14|13|12}|e} |
        {{11|10|9}|p} |
        {{8|7|6}|q} |
        {{5|4|3}|r} |
        {{2|1|0}|t}
    }"];
}-->

<p><img src="../../assets/svgs/lab4_graphviz_3.svg" alt="graphviz_3"></p>
<h5 id="3-shape-parameter-shape_param1-please-refer-to-the-paper-for-the-definition">3. Shape Parameter (shape_param1) - Please refer to the paper for the definition.</h5>
<!--digraph {
    rankdir="LR"
    node [shape=record];
    bits [label="{
        {{31|30|29}|reserved} |
        {{28|27|26}|PAD} |
        {{25|24}|U} |
        {{23|22}|R} |
        {{21|20}|S} |
        {{19 ... 10}|C} |
        {{9 ... 0}|M}
    }"];
}-->

<p><img src="../../assets/svgs/lab4_graphviz_4.svg" alt="graphviz_4"></p>
<ul>
<li><strong><code>PAD = 1</code></strong>: Only padding of size 1 is supported. Other padding sizes will not be implemented in this lab.</li>
</ul>
<h5 id="4-shape-parameter-2-shape_param2-please-refer-to-the-paper-for-the-definition">4. Shape Parameter 2 (shape_param2) - Please refer to the paper for the definition.</h5>
<!--digraph {
    rankdir="LR"
    node [shape=record];
    bits [label="{
        {{31 ... 16}|reserved} |
        {{15|14|13|12|11|10|9|8}|W} |
        {{7|6|5|4|3|2|1|0}|H}
    }"];
}-->

<p><img src="../../assets/svgs/lab4_graphviz_5.svg" alt="graphviz_5"></p>
<p><strong>Note:</strong> Ensure to account for padding when calculating width (W) and height (H) before writing the value to the register. Add <code>2 * padding</code> to both <code>W</code> and <code>H</code>, then apply the necessary bitwise operations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<h4 id="memory-write-operation">Memory Write Operation</h4>
<h5 id="using-the-reg_write-function">Using the <code>reg_write</code> Function</h5>
<p>In this assignment, you are required to use the function <code>reg_write(uint32_t offset, uint32_t value);</code> provided in <code>hardware_dla.h</code> to write values to a specific memory location.</p>
<h5 id="function-prototype">Function Prototype</h5>
<div class="language-c highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">reg_write</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span></code></pre></div>
<h5 id="parameters">Parameters</h5>
<ul>
<li><strong>offset</strong>: The offset of the target memory location (relative to the DLA base address).</li>
<li><strong>value</strong>: The value to be written.</li>
</ul>
<h5 id="functionality">Functionality</h5>
<p>Writes <code>value</code> to the memory location corresponding to <code>DLA_MMIO_BASE_ADDR + offset</code>.</p>
</div>
<h4 id="a-function-call-based-runtime-api-for-common-dnn-operations">A function call-based runtime API for common DNN operations</h4>
<p>After completing the low-level MMIO configuration driver, we need to implement appropriate computation APIs for the operations supported by the DLA.</p>
<h5 id="configuration-for-glb-memory-allocation">Configuration for GLB memory allocation</h5>
<p><strong>"The size of the GLB is configured to 64 KB."</strong></p>
<p><img alt="image" src="../../assets/images/SyR76DmJxe.png" /></p>
<p>Students can implement the design based on the illustration provided in this diagram. The size of each block can be computed based on the shape parameters and mapping parameters, following the methodology used in the previous lab.</p>
<ul>
<li>In the file <code>src/eyeriss/dla/runtime/dla.cpp</code>, you need to implement the <code>qconv2d_relu_maxpool</code> and <code>qconv2d_relu</code> functions to correctly activate the DLA. Before configuring the MMIO registers, you must determine the optimal <code>m</code> parameter in the runtime to maximize GLB utilization. As you learned in Lab 2, the value of <code>m</code> affects the size of the output feature map (ofmap) and bias stored in the GLB. Therefore, you need to calculate the largest power-of-two value for <code>m</code> that fits within the available GLB space.</li>
<li>The buffer allocation for the input feature map (ifmap) within the GLB does not need to consider padding, as its required space can be fully determined by the mapping and shape parameters.The DLA controller is aware of the padding size and includes corresponding logic to handle it, so this aspect does not need to be explicitly considered. While the previous analysis provides valuable design insights, there may be slight discrepancies during implementation due to various trade-offs.</li>
</ul>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">src/eyeriss/dla/runtime_dla.cpp</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-66">66</a></span>
<span class="normal"><a href="#__codelineno-48-67">67</a></span>
<span class="normal"><a href="#__codelineno-48-68">68</a></span>
<span class="normal"><a href="#__codelineno-48-69">69</a></span>
<span class="normal"><a href="#__codelineno-48-70">70</a></span>
<span class="normal"><a href="#__codelineno-48-71">71</a></span>
<span class="normal"><a href="#__codelineno-48-72">72</a></span>
<span class="normal"><a href="#__codelineno-48-73">73</a></span>
<span class="normal"><a href="#__codelineno-48-74">74</a></span>
<span class="normal"><a href="#__codelineno-48-75">75</a></span>
<span class="normal"><a href="#__codelineno-48-76">76</a></span>
<span class="normal"><a href="#__codelineno-48-77">77</a></span>
<span class="normal"><a href="#__codelineno-48-78">78</a></span>
<span class="normal"><a href="#__codelineno-48-79">79</a></span>
<span class="normal"><a href="#__codelineno-48-80">80</a></span>
<span class="normal"><a href="#__codelineno-48-81">81</a></span>
<span class="normal"><a href="#__codelineno-48-82">82</a></span>
<span class="normal"><a href="#__codelineno-48-83">83</a></span>
<span class="normal"><a href="#__codelineno-48-84">84</a></span>
<span class="normal"><a href="#__codelineno-48-85">85</a></span>
<span class="normal"><a href="#__codelineno-48-86">86</a></span>
<span class="normal"><a href="#__codelineno-48-87">87</a></span>
<span class="normal"><a href="#__codelineno-48-88">88</a></span>
<span class="normal"><a href="#__codelineno-48-89">89</a></span>
<span class="normal"><a href="#__codelineno-48-90">90</a></span>
<span class="normal"><a href="#__codelineno-48-91">91</a></span>
<span class="normal"><a href="#__codelineno-48-92">92</a></span>
<span class="normal"><a href="#__codelineno-48-93">93</a></span>
<span class="normal"><a href="#__codelineno-48-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-66"><a id="__codelineno-48-66" name="__codelineno-48-66"></a><span class="kt">int</span><span class="w"> </span><span class="nf">qconv2d_relu_maxpool</span><span class="p">(</span>
</span><span id="__span-48-67"><a id="__codelineno-48-67" name="__codelineno-48-67"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">input_in_DRAM</span><span class="p">,</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">filter_in_DRAM</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">opsum_in_DRAM</span><span class="p">,</span>
</span><span id="__span-48-68"><a id="__codelineno-48-68" name="__codelineno-48-68"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="o">*</span><span class="n">bias</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ofmap_len</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ifmap_len</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">filter_len</span><span class="p">,</span>
</span><span id="__span-48-69"><a id="__codelineno-48-69" name="__codelineno-48-69"></a><span class="w">    </span><span class="c1">// mapping parameter</span>
</span><span id="__span-48-70"><a id="__codelineno-48-70" name="__codelineno-48-70"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
</span><span id="__span-48-71"><a id="__codelineno-48-71" name="__codelineno-48-71"></a><span class="w">    </span><span class="c1">// shape parameter</span>
</span><span id="__span-48-72"><a id="__codelineno-48-72" name="__codelineno-48-72"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">PAD</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">M</span><span class="p">,</span>
</span><span id="__span-48-73"><a id="__codelineno-48-73" name="__codelineno-48-73"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">H</span><span class="p">,</span>
</span><span id="__span-48-74"><a id="__codelineno-48-74" name="__codelineno-48-74"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// int32_t scale_factor: merge ifmap and weight and ofmap</span>
</span><span id="__span-48-75"><a id="__codelineno-48-75" name="__codelineno-48-75"></a><span class="w">    </span><span class="c1">// scale bit-shift</span>
</span><span id="__span-48-76"><a id="__codelineno-48-76" name="__codelineno-48-76"></a>
</span><span id="__span-48-77"><a id="__codelineno-48-77" name="__codelineno-48-77"></a><span class="cp">#ifdef DLA_INFO</span>
</span><span id="__span-48-78"><a id="__codelineno-48-78" name="__codelineno-48-78"></a><span class="w">    </span><span class="n">dla_reset_runtime_info</span><span class="p">();</span>
</span><span id="__span-48-79"><a id="__codelineno-48-79" name="__codelineno-48-79"></a><span class="cp">#endif</span>
</span><span id="__span-48-80"><a id="__codelineno-48-80" name="__codelineno-48-80"></a><span class="w">    </span><span class="c1">// Calculate m for GLB memory allocation</span>
</span><span id="__span-48-81"><a id="__codelineno-48-81" name="__codelineno-48-81"></a><span class="w">    </span><span class="cm">/*! &lt;&lt;&lt;========= Implement here =========&gt;&gt;&gt;*/</span>
</span><span id="__span-48-82"><a id="__codelineno-48-82" name="__codelineno-48-82"></a>
</span><span id="__span-48-83"><a id="__codelineno-48-83" name="__codelineno-48-83"></a>
</span><span id="__span-48-84"><a id="__codelineno-48-84" name="__codelineno-48-84"></a><span class="w">    </span><span class="c1">// call lower setting functions</span>
</span><span id="__span-48-85"><a id="__codelineno-48-85" name="__codelineno-48-85"></a><span class="w">    </span><span class="cm">/*! &lt;&lt;&lt;========= Implement here =========&gt;&gt;&gt;*/</span>
</span><span id="__span-48-86"><a id="__codelineno-48-86" name="__codelineno-48-86"></a>
</span><span id="__span-48-87"><a id="__codelineno-48-87" name="__codelineno-48-87"></a><span class="w">    </span><span class="n">wait_for_interrupt</span><span class="p">();</span>
</span><span id="__span-48-88"><a id="__codelineno-48-88" name="__codelineno-48-88"></a><span class="w">    </span><span class="n">dla_stop</span><span class="p">();</span>
</span><span id="__span-48-89"><a id="__codelineno-48-89" name="__codelineno-48-89"></a><span class="cp">#ifdef DLA_INFO</span>
</span><span id="__span-48-90"><a id="__codelineno-48-90" name="__codelineno-48-90"></a><span class="w">    </span><span class="n">dump_dla_info_to_csv</span><span class="p">(</span><span class="n">DLA_INFO_CSV</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qconv2d_relu_maxpool&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
</span><span id="__span-48-91"><a id="__codelineno-48-91" name="__codelineno-48-91"></a><span class="w">                         </span><span class="n">PAD</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">);</span>
</span><span id="__span-48-92"><a id="__codelineno-48-92" name="__codelineno-48-92"></a><span class="cp">#endif</span>
</span><span id="__span-48-93"><a id="__codelineno-48-93" name="__codelineno-48-93"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-48-94"><a id="__codelineno-48-94" name="__codelineno-48-94"></a><span class="p">};</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<h5 id="a-different-glb-configuration-from-the-previous">A different GLB configuration from the previous</h5>
<p>One key difference in this assignment compared to the previous one is <code>the number of bias values</code> stored in the <code>GLB</code>. In this case, the number of bias values in GLB is <code>m</code>, and storing <code>m</code> biases in the GLB rather than <code>p × t</code> can reduce the number of DRAM accesses, saving handshake time. This change does not affect the number of opsums.
Another is <strong>the space occupied by the ifmap</strong> does not need to account for <code>padding</code>, as it can be determined solely by the mapping parameters and shape parameters.</p>
</div>
<p>To better understand the source file, you may start by reading the corresponding header file.</p>
<h4 id="dla-testbench-user-guide">DLA Testbench user guide</h4>
<p><strong>Note:</strong> The implementation of <code>hal.cpp</code> is also required.
There are four testcase (dla0 ~ dla3)</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Testbench</th>
<th>test API</th>
<th style="text-align: center;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">dla0</td>
<td>qconv2d_relu</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">dla1</td>
<td>qconv2d_relu_maxpool</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">dla2</td>
<td>qconv2d_relu_maxpool</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">dla3</td>
<td>qconv2d_relu_maxpool, qconv2d_relu_maxpool_cpu</td>
<td style="text-align: center;">you need to implement original cpu version first in HW4.2</td>
</tr>
</tbody>
</table>
<p>Run the testbench separately.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nb">cd</span><span class="w"> </span>test/dla/dla&lt;testcase&gt;
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>make<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div>
<p>For more Makefile usage</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nb">cd</span><span class="w"> </span>test/dla/dla&lt;testcase&gt;
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>make<span class="w"> </span>&lt;usage&gt;
</span></code></pre></div>
<p>We provide a counter in the HAL to record DLA information, which will be dumped into a <code>.csv</code> file when the user enables it by running</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>make all DLA_INFO=1
</span></code></pre></div>
<p>Run all testbench without any configurations</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="nb">cd</span><span class="w"> </span>test/dla
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>make<span class="w"> </span><span class="nb">test</span>
</span></code></pre></div>
<p>Please be patient, as the simulation could take some time to complete.
Make sure to take a screenshot of the simulation output if your test passes.</p>
<h3 id="2-cpu-runtime-api">2. CPU Runtime API</h3>
<p>Since there are still some operations that are not supported by the accelerator, it is necessary to implement such operations purely running on the CPU, namely <strong>CPU fallback support</strong>. Additionally, in certain embedded systems where accelerators are absent, AI model inference must be performed using only the CPU. This motivates us to develop such a library.</p>
<p>We’ve learned about memory hierarchy in computer organization, which helps us optimize for memory cache when performing CPU-only computations. Therefore, we need to implement basic algorithms as well as cache-optimized versions, and use tools like <strong>Valgrind</strong> to measure the effectiveness of these optimizations.</p>
<h4 id="implementation-requirements">Implementation requirements</h4>
<p>Complete the blank sections in the following files:</p>
<ul>
<li><code>/src/eyeriss/cpu/improve/hardware_cpu.c</code></li>
<li><code>/src/eyeriss/cpu/original/hardware_cpu.c</code></li>
</ul>
<p>Makefiles are also provided under the corresponding directories to compile the library, execute the program, and analysis the performance.</p>
<ul>
<li>
<p><strong>Original Version Implementation</strong></p>
<ul>
<li>In <code>/src/eyeriss/cpu/original/hardware_cpu.c</code>, the <code>conv</code> and <code>conv_maxpooling</code> functions must be implemented using <strong>6 nested for loops</strong> to fully cover the computation across output channel, output height, output width, input channel, filter height, and filter width.</li>
<li>The <code>linear</code> and <code>linear_relu</code> functions must be implemented using <strong>2 nested for loops</strong>, corresponding to matrix-vector multiplication (output dimension × input dimension).</li>
<li>Each operation contributes 7.5 points to the overall score.</li>
</ul>
</li>
<li>
<p><strong>Improved Version Implementation</strong>
    You can use loop tiling or any method you want to reduse the cache miss rate and cycles, improve program without complier optimize. We will use cachegrind to simulate the limited cache size.</p>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab3/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lab 3 - Hardware Architecture Design">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Lab 3 - Hardware Architecture Design
              </div>
            </div>
          </a>
        
        
          
          <a href="../lab5/" class="md-footer__link md-footer__link--next" aria-label="Next: Lab 5 - AI Compiler">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Lab 5 - AI Compiler
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/NCKU-AISLAB/force-ai" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.path", "navigation.top", "navigation.footer", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/rod2ik/cdn@main/mkdocs/javascripts/mkdocs-graphviz.js"></script>
      
    
  </body>
</html>